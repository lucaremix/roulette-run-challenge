<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Falkner Type Battle</title>
<style>
body{
  background:#0a0a0a;color:#e0e0e0;
  font-family:'Segoe UI',sans-serif;
  padding:20px;
}
.container{max-width:900px;margin:auto}
.waiting-screen,.battle-screen,.result-screen{
  background:#1a1a1a;border:1px solid #2a2a2a;border-radius:12px;
  padding:40px;text-align:center;display:none
}
button{
  border:none;border-radius:8px;padding:15px 25px;font-size:1.2em;
  cursor:pointer;transition:0.2s;
}
.ready-btn{background:#2a7a2a;color:#fff}
.ready-btn:hover{background:#3d9c3d}
.submit-btn{background:#2a7a2a;color:#fff;width:100%;margin-top:10px}
.submit-btn:hover{background:#3d9c3d}
input{
  width:100%;padding:10px;background:#0a0a0a;border:1px solid #2a2a2a;
  border-radius:8px;color:#e0e0e0;font-size:1em
}
.suggestions{
  background:#0a0a0a;border:1px solid #2a2a2a;border-radius:8px;
  text-align:left;margin-top:5px;display:none;max-height:200px;overflow-y:auto
}
.suggestion-item{padding:8px 10px;cursor:pointer}
.suggestion-item:hover{background:#222}
.timer{font-size:2.5em;margin:10px 0;color:#7fff7f}
.player-panel.active{border:2px solid #87CEEB;padding:20px;border-radius:10px}
.used-tag{
  display:inline-block;background:#2a2a2a;padding:5px 10px;border-radius:6px;margin:3px
}
</style>
</head>
<body>
<div class="container">
  <div id="waitingScreen" class="waiting-screen">
    <h2>‚è≥ In attesa...</h2>
    <p id="waitingMessage">In attesa di giocatori...</p>
    <button id="readyBtn" class="ready-btn">‚úÖ Sono pronto!</button>
  </div>

  <div id="battleScreen" class="battle-screen">
    <h1>ü¶Ö Sfida di Tipo Falkner</h1>
    <div id="typeDisplay" style="font-size:1.5em;margin-bottom:20px;"></div>
    <div class="timer" id="timerDisplay">15</div>

    <div id="turnDisplay" style="margin:10px 0 20px;"></div>

    <div class="player-panel" id="playerPanel">
      <h3 id="playerName"></h3>
      <input type="text" id="pokemonInput" placeholder="Scrivi un Pok√©mon...">
      <div class="suggestions" id="suggestions"></div>
      <button id="submitBtn" class="submit-btn">Conferma</button>
      <div id="usedList" style="margin-top:20px;text-align:left"></div>
    </div>
  </div>

  <div id="resultScreen" class="result-screen">
    <h2 id="resultTitle"></h2>
    <p id="resultMessage"></p>
    <button class="ready-btn" onclick="window.location.href='index.html'">üè† Torna alla Home</button>
  </div>
</div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getDatabase,ref,set,get,update,onValue,remove,onDisconnect} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig={
 apiKey:"AIzaSyDNuD9wViLLxteHMCEBlvfdONwcZbAjAvo",
 authDomain:"roulette-run-challenge.firebaseapp.com",
 databaseURL:"https://roulette-run-challenge-default-rtdb.europe-west1.firebasedatabase.app",
 projectId:"roulette-run-challenge",
 storageBucket:"roulette-run-challenge.firebasestorage.app",
 messagingSenderId:"994019156093",
 appId:"1:994019156093:web:9792bdce75c486f589d114"
};
const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

let currentPlayer=localStorage.getItem('playerName')||'';
let allPokemon=[],gameState=null,myIndex=-1,countdown=null;

// --- carica CSV ---
async function loadPokemonData(){
  const r=await fetch('https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/pokemon.csv');
  const t=await r.text();const lines=t.split('\n').filter(l=>l.trim());
  const h=lines[0].split('\t');const ni=h.findIndex(x=>x.includes('english_name'));
  for(let i=1;i<lines.length;i++){const v=lines[i].split('\t');
    if(v[ni]) allPokemon.push(v[ni].trim());
  }
  console.log("Caricati",allPokemon.length,"Pok√©mon");
}

// --- entra nell'evento ---
async function joinEventAndWait(){
  const playersRef=ref(db,'events/falkner/players');
  const snap=await get(playersRef);const arr=[];
  snap.forEach(s=>arr.push(s.val()));
  if(!arr.includes(currentPlayer)){
    await set(ref(db,`events/falkner/players/${currentPlayer}`),currentPlayer);
    try{onDisconnect(ref(db,`events/falkner/players/${currentPlayer}`)).remove();}catch{}
  }
  return new Promise((resolve)=>{
    onValue(playersRef,s=>{
      const p=[];s.forEach(cs=>p.push(cs.val()));
      document.getElementById('waitingScreen').style.display='block';
      document.getElementById('waitingMessage').textContent=`Giocatori collegati: ${p.length}/2`;
      if(p.length===2) resolve(p);
    });
  });
}

// --- inizio gioco ---
async function initializeGame(){
  if(!currentPlayer){alert("Imposta il nome dalla home.");window.location.href='index.html';return;}
  const players=await joinEventAndWait();
  myIndex=players.indexOf(currentPlayer);
  const gameRef=ref(db,'events/falkner/gameState');
  const gsSnap=await get(gameRef);
  if(!gsSnap.exists()){
    const types=['normal','fire','water','electric','grass','ice','fighting','poison','ground','flying','psychic','bug','rock','ghost','dragon','dark','steel','fairy'];
    const t=types[Math.floor(Math.random()*types.length)];
    await set(gameRef,{
      players,selectedType:t,usedPokemon:[],
      currentPlayerIndex:0,timeLeft:15,started:false,winner:null,lastUpdate:Date.now(),ready:{}
    });
  }
  onValue(gameRef,s=>{
    gameState=s.val();if(!gameState)return;updateUI(gameRef);
  });
}

// --- UI update ---
async function updateUI(gameRef){
  const w=document.getElementById('waitingScreen');
  const b=document.getElementById('battleScreen');
  const r=document.getElementById('resultScreen');
  if(!gameState.started){
    w.style.display='block';b.style.display='none';r.style.display='none';
    const ready=gameState.ready?.[currentPlayer];const n=Object.keys(gameState.ready||{}).length;
    document.getElementById('waitingMessage').textContent=`Giocatori pronti: ${n}/2`;
    document.getElementById('readyBtn').disabled=ready;
    if(n===2 && myIndex===0) await update(gameRef,{started:true,lastUpdate:Date.now()});
    return;
  }
  w.style.display='none';b.style.display='block';r.style.display='none';
  if(gameState.winner!==null){showResult();return;}
  document.getElementById('typeDisplay').textContent=`Tipo: ${gameState.selectedType}`;
  document.getElementById('playerName').textContent=currentPlayer;
  document.getElementById('turnDisplay').textContent=`Turno di: ${gameState.players[gameState.currentPlayerIndex]}`;
  document.getElementById('timerDisplay').textContent=gameState.timeLeft;
  const isMyTurn=(myIndex===gameState.currentPlayerIndex);
  document.getElementById('pokemonInput').disabled=!isMyTurn;
  document.getElementById('submitBtn').disabled=!isMyTurn;
  const used=document.getElementById('usedList');
  used.innerHTML=gameState.usedPokemon.map(p=>`<span class='used-tag'>${p}</span>`).join('');
  if(!countdown && gameState.started && myIndex===0) startTimer(gameRef);
}

// --- timer globale ---
function startTimer(gameRef){
  countdown=setInterval(async()=>{
    if(!gameState||gameState.winner!==null)return;
    const now=Date.now();
    const elapsed=Math.floor((now-(gameState.lastUpdate||now))/1000);
    if(elapsed<1)return;
    const newTime=Math.max(0,gameState.timeLeft-1);
    if(newTime<=0){
      const winner=(gameState.currentPlayerIndex===0)?1:0;
      await update(gameRef,{winner});
      clearInterval(countdown);countdown=null;
    }else{
      await update(gameRef,{timeLeft:newTime,lastUpdate:now});
    }
  },1000);
}

// --- pronto ---
document.getElementById('readyBtn').addEventListener('click',async()=>{
  const gameRef=ref(db,'events/falkner/gameState');
  await update(gameRef,{[`ready/${currentPlayer}`]:true});
});

// --- suggerimenti ---
const input=document.getElementById('pokemonInput');
const sugg=document.getElementById('suggestions');
input.addEventListener('input',()=>{
  const val=input.value.toLowerCase();
  if(val.length<2){sugg.style.display='none';return;}
  const res=allPokemon.filter(p=>p.toLowerCase().includes(val)).slice(0,10);
  sugg.innerHTML=res.map(p=>`<div class='suggestion-item'>${p}</div>`).join('');
  sugg.style.display=res.length?'block':'none';
});
sugg.addEventListener('click',e=>{
  if(e.target.classList.contains('suggestion-item')){
    input.value=e.target.textContent;sugg.style.display='none';
  }
});

// --- invio Pok√©mon ---
document.getElementById('submitBtn').addEventListener('click',submitPokemon);
async function submitPokemon(){
  const name=input.value.trim();
  if(!name)return;
  const gameRef=ref(db,'events/falkner/gameState');
  const p=allPokemon.find(n=>n.toLowerCase()===name.toLowerCase());
  if(!p){alert('Pok√©mon non trovato!');return;}
  if(gameState.usedPokemon.includes(p)){
    await update(gameRef,{winner:(myIndex===0)?1:0});
    return;
  }
  // Tipo corretto?
  const url='https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/pokemon.csv';
  const r=await fetch(url);const t=await r.text();const lines=t.split('\n');const headers=lines[0].split('\t');
  const ni=headers.findIndex(h=>h.includes('english_name'));
  const pti=headers.findIndex(h=>h.includes('primary_type'));
  const sti=headers.findIndex(h=>h.includes('secondary_type'));
  const row=lines.find(l=>l.split('\t')[ni]?.trim()===p);
  if(!row){alert('Pok√©mon non trovato nel CSV');return;}
  const vals=row.split('\t');const type1=vals[pti]?.trim();const type2=vals[sti]?.trim();
  if(type1!==gameState.selectedType && type2!==gameState.selectedType){
    await update(gameRef,{winner:(myIndex===0)?1:0});
    return;
  }
  // OK
  const next=(gameState.currentPlayerIndex===0)?1:0;
  await update(gameRef,{
    usedPokemon:[...gameState.usedPokemon,p],
    currentPlayerIndex:next,
    timeLeft:15,
    lastUpdate:Date.now()
  });
  input.value='';sugg.style.display='none';
}

// --- risultato ---
function showResult(){
  clearInterval(countdown);countdown=null;
  document.getElementById('battleScreen').style.display='none';
  document.getElementById('resultScreen').style.display='block';
  const win=gameState.winner===myIndex;
  document.getElementById('resultTitle').textContent=win?'üéâ Vittoria!':'üíÄ Sconfitta!';
  document.getElementById('resultMessage').textContent=win?'Hai vinto la sfida!':'Hai perso la sfida!';
}

// --- cleanup ---
window.addEventListener('beforeunload',()=>{
  if(currentPlayer) remove(ref(db,`events/falkner/players/${currentPlayer}`));
});

// --- avvio ---
await loadPokemonData();
await initializeGame();
</script>
</body>
</html>
