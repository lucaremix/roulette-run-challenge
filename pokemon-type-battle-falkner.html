<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falkner Type Battle - Roulette Run Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
        }

        h1 {
            font-size: 2.5em;
            color: #87CEEB;
            margin-bottom: 10px;
        }

        .type-display {
            font-size: 2em;
            padding: 15px 30px;
            background: #2a2a2a;
            border-radius: 8px;
            display: inline-block;
            margin: 20px 0;
            text-transform: capitalize;
            font-weight: bold;
        }

        .battle-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .player-panel {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
        }

        .player-panel.active {
            border-color: #87CEEB;
            box-shadow: 0 0 20px rgba(135, 206, 235, 0.3);
        }

        .player-name {
            font-size: 1.5em;
            color: #fff;
            margin-bottom: 10px;
        }

        .timer {
            font-size: 3em;
            font-weight: bold;
            color: #7fff7f;
            margin: 20px 0;
            text-align: center;
        }

        .timer.warning {
            color: #ff6b6b;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .input-area {
            margin: 20px 0;
        }

        .pokemon-input {
            width: 100%;
            padding: 15px;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1.1em;
        }

        .pokemon-input:focus {
            outline: none;
            border-color: #87CEEB;
        }

        .pokemon-input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .suggestions {
            max-height: 200px;
            overflow-y: auto;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }

        .suggestions.show {
            display: block;
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #1a1a1a;
        }

        .suggestion-item:hover {
            background: #1a1a1a;
        }

        .submit-btn {
            width: 100%;
            padding: 15px;
            background: #2a7a2a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 15px;
        }

        .submit-btn:hover:not(:disabled) {
            background: #357a35;
            transform: scale(1.02);
        }

        .submit-btn:disabled {
            background: #2a2a2a;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .used-pokemon {
            margin-top: 20px;
        }

        .used-title {
            font-size: 1.1em;
            color: #888;
            margin-bottom: 10px;
        }

        .used-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .used-tag {
            background: #2a2a2a;
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #ccc;
        }

        .result-screen {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            display: none;
        }

        .result-screen.show {
            display: block;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-title {
            font-size: 2.5em;
            margin-bottom: 20px;
        }

        .result-title.winner {
            color: #7fff7f;
        }

        .result-title.loser {
            color: #ff6b6b;
        }

        .rewards-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 30px 0;
        }

        .reward-item {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 1.2em;
        }

        .reward-item.highlight {
            background: #2d4a2d;
            border-color: #4a7a4a;
            color: #7fff7f;
            font-weight: bold;
        }

        .home-btn {
            padding: 15px 40px;
            background: #2a7a2a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .home-btn:hover {
            background: #357a35;
        }

        @media (max-width: 968px) {
            .battle-area {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header id="header">
            <h1>ü¶Ö Sfida di Tipo Falkner</h1>
            <div id="typeDisplay" class="type-display">Caricamento...</div>
        </header>

        <div class="battle-area" id="battleArea">
            <div class="player-panel" id="player1Panel">
                <div class="player-name" id="player1Name">Giocatore 1</div>
                <div class="timer" id="timer1">15</div>
                
                <div class="input-area">
                    <input type="text" 
                           class="pokemon-input" 
                           id="pokemonInput1" 
                           placeholder="Scrivi il nome del Pok√©mon..."
                           autocomplete="off"
                           disabled>
                    <div class="suggestions" id="suggestions1"></div>
                </div>
                
                <button class="submit-btn" id="submitBtn1" disabled>Conferma</button>

                <div class="used-pokemon">
                    <div class="used-title">Pok√©mon usati:</div>
                    <div class="used-list" id="usedList1"></div>
                </div>
            </div>

            <div class="player-panel" id="player2Panel">
                <div class="player-name" id="player2Name">Giocatore 2</div>
                <div class="timer" id="timer2">15</div>
                
                <div class="input-area">
                    <input type="text" 
                           class="pokemon-input" 
                           id="pokemonInput2" 
                           placeholder="Scrivi il nome del Pok√©mon..."
                           autocomplete="off"
                           disabled>
                    <div class="suggestions" id="suggestions2"></div>
                </div>
                
                <button class="submit-btn" id="submitBtn2" disabled>Conferma</button>

                <div class="used-pokemon">
                    <div class="used-title">Pok√©mon usati:</div>
                    <div class="used-list" id="usedList2"></div>
                </div>
            </div>
        </div>

        <div class="result-screen" id="resultScreen">
            <h2 class="result-title" id="resultTitle">Vittoria!</h2>
            <p id="resultMessage" style="font-size: 1.3em; margin: 20px 0;"></p>
            <div class="rewards-list" id="rewardsList"></div>
            <button class="home-btn" onclick="goHome()">üè† Torna alla Home</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, get, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDNuD9wViLLxteHMCEBlvfdONwcZbAjAvo",
            authDomain: "roulette-run-challenge.firebaseapp.com",
            databaseURL: "https://roulette-run-challenge-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "roulette-run-challenge",
            storageBucket: "roulette-run-challenge.firebasestorage.app",
            messagingSenderId: "994019156093",
            appId: "1:994019156093:web:9792bdce75c486f589d114"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let allPokemon = [];
        let selectedType = '';
        let validPokemon = [];
        let usedPokemon = [];
        let players = [];
        let currentPlayerIndex = 0;
        let timerInterval = null;
        let timeLeft = 15;
        let selectedPokemonName = '';
        let currentPlayer = '';

        const typeTranslations = {
            'normal': 'Normale',
            'fire': 'Fuoco',
            'water': 'Acqua',
            'electric': 'Elettro',
            'grass': 'Erba',
            'ice': 'Ghiaccio',
            'fighting': 'Lotta',
            'poison': 'Veleno',
            'ground': 'Terra',
            'flying': 'Volante',
            'psychic': 'Psico',
            'bug': 'Coleottero',
            'rock': 'Roccia',
            'ghost': 'Spettro',
            'dragon': 'Drago',
            'dark': 'Buio',
            'steel': 'Acciaio',
            'fairy': 'Folletto'
        };

        function getCurrentPlayer() {
            return localStorage.getItem('playerName') || '';
        }

        async function loadPokemonData() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/pokemon.csv');
                const csvText = await response.text();
                
                const lines = csvText.split('\n');
                const headers = lines[0].split('\t').map(h => h.replace(/\uFEFF/g, '').replace(/\u0000/g, '').trim());
                
                const nameIndex = headers.findIndex(h => h.includes('english_name'));
                const primaryTypeIndex = headers.findIndex(h => h.includes('primary_type'));
                const secondaryTypeIndex = headers.findIndex(h => h.includes('secondary_type'));

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;
                    
                    const values = lines[i].split('\t');
                    const name = values[nameIndex]?.replace(/\u0000/g, '').trim();
                    const primaryType = values[primaryTypeIndex]?.replace(/\u0000/g, '').trim();
                    const secondaryType = values[secondaryTypeIndex]?.replace(/\u0000/g, '').trim();
                    
                    if (name) {
                        allPokemon.push({
                            name: name,
                            primaryType: primaryType,
                            secondaryType: secondaryType
                        });
                    }
                }

                console.log(`Caricati ${allPokemon.length} Pok√©mon`);
            } catch (error) {
                console.error('Errore caricamento CSV:', error);
                alert('Errore nel caricamento dei dati Pok√©mon!');
            }
        }

        async function initializeBattle() {
            currentPlayer = getCurrentPlayer();
            
            const eventRef = ref(database, 'events/falkner/players');
            const snapshot = await get(eventRef);
            
            snapshot.forEach((childSnapshot) => {
                players.push(childSnapshot.val());
            });

            if (players.length !== 2) {
                alert('Errore: devono esserci esattamente 2 giocatori!');
                window.location.href = 'falkner.html';
                return;
            }

            document.getElementById('player1Name').textContent = players[0];
            document.getElementById('player2Name').textContent = players[1];

            const types = ['normal', 'fire', 'water', 'electric', 'grass', 'ice', 'fighting', 
                          'poison', 'ground', 'flying', 'psychic', 'bug', 'rock', 'ghost', 
                          'dragon', 'dark', 'steel', 'fairy'];
            
            selectedType = types[Math.floor(Math.random() * types.length)];
            
            validPokemon = allPokemon.filter(p => 
                p.primaryType === selectedType || p.secondaryType === selectedType
            );

            console.log(`Tipo selezionato: ${selectedType}, Pok√©mon validi: ${validPokemon.length}`);

            document.getElementById('typeDisplay').textContent = typeTranslations[selectedType] || selectedType;

            startTurn();
        }

        function startTurn() {
            currentPlayerIndex = usedPokemon.length % 2;
            const isMyTurn = players[currentPlayerIndex] === currentPlayer;

            document.getElementById('player1Panel').classList.toggle('active', currentPlayerIndex === 0);
            document.getElementById('player2Panel').classList.toggle('active', currentPlayerIndex === 1);

            const input1 = document.getElementById('pokemonInput1');
            const input2 = document.getElementById('pokemonInput2');
            const btn1 = document.getElementById('submitBtn1');
            const btn2 = document.getElementById('submitBtn2');

            input1.disabled = currentPlayerIndex !== 0 || !isMyTurn;
            input2.disabled = currentPlayerIndex !== 1 || !isMyTurn;
            btn1.disabled = currentPlayerIndex !== 0 || !isMyTurn;
            btn2.disabled = currentPlayerIndex !== 1 || !isMyTurn;

            if (isMyTurn) {
                const input = currentPlayerIndex === 0 ? input1 : input2;
                input.focus();
            }

            timeLeft = 15;
            updateTimers();
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimers();
                
                if (timeLeft <= 5) {
                    const timer = currentPlayerIndex === 0 ? 
                        document.getElementById('timer1') : 
                        document.getElementById('timer2');
                    timer.classList.add('warning');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    endGame(currentPlayerIndex === 0 ? 1 : 0);
                }
            }, 1000);
        }

        function updateTimers() {
            document.getElementById('timer1').textContent = currentPlayerIndex === 0 ? timeLeft : '--';
            document.getElementById('timer2').textContent = currentPlayerIndex === 1 ? timeLeft : '--';
            
            document.getElementById('timer1').classList.remove('warning');
            document.getElementById('timer2').classList.remove('warning');
        }

        function filterPokemon(searchText) {
            if (!searchText || searchText.length < 2) return [];
            
            const search = searchText.toLowerCase();
            return validPokemon
                .filter(p => 
                    p.name.toLowerCase().includes(search) && 
                    !usedPokemon.includes(p.name)
                )
                .slice(0, 10);
        }

        function showSuggestions(filtered, playerNum) {
            const container = document.getElementById(`suggestions${playerNum}`);
            
            if (filtered.length === 0) {
                container.classList.remove('show');
                return;
            }

            container.innerHTML = filtered.map(p => `
                <div class="suggestion-item" onclick="selectPokemon('${p.name}', ${playerNum})">
                    ${p.name}
                </div>
            `).join('');
            
            container.classList.add('show');
        }

        window.selectPokemon = function(name, playerNum) {
            selectedPokemonName = name;
            document.getElementById(`pokemonInput${playerNum}`).value = name;
            document.getElementById(`suggestions${playerNum}`).classList.remove('show');
        };

        function submitPokemon(playerNum) {
            if (!selectedPokemonName) {
                alert('Seleziona un Pok√©mon valido dalla lista!');
                return;
            }

            const pokemon = validPokemon.find(p => p.name === selectedPokemonName);
            
            if (!pokemon) {
                alert('Pok√©mon non valido per questo tipo!');
                return;
            }

            if (usedPokemon.includes(pokemon.name)) {
                alert('Questo Pok√©mon √® gi√† stato usato!');
                return;
            }

            usedPokemon.push(pokemon.name);
            
            const usedList = document.getElementById(`usedList${playerNum}`);
            const tag = document.createElement('div');
            tag.className = 'used-tag';
            tag.textContent = pokemon.name;
            usedList.appendChild(tag);

            document.getElementById(`pokemonInput${playerNum}`).value = '';
            selectedPokemonName = '';

            clearInterval(timerInterval);
            
            setTimeout(() => {
                startTurn();
            }, 500);
        }

        async function endGame(winnerIndex) {
            clearInterval(timerInterval);

            document.getElementById('battleArea').style.display = 'none';
            document.getElementById('header').style.display = 'none';
            
            const winner = players[winnerIndex];
            const loser = players[1 - winnerIndex];
            const isWinner = winner === currentPlayer;

            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');

            if (isWinner) {
                resultTitle.textContent = 'üéâ Vittoria!';
                resultTitle.className = 'result-title winner';
                resultMessage.textContent = `Complimenti ${winner}, hai vinto!`;
            } else {
                resultTitle.textContent = 'üò¢ Sconfitta';
                resultTitle.className = 'result-title loser';
                resultMessage.textContent = `${winner} ha vinto la sfida!`;
            }

            await giveRewards(winner, loser);

            document.getElementById('resultScreen').classList.add('show');
        }

        async function giveRewards(winner, loser) {
            const rewardsList = document.getElementById('rewardsList');
            rewardsList.innerHTML = '';

            if (currentPlayer === winner) {
                const rewards = [
                    { text: 'üé∞ 1 Spin dal Pool B', highlight: true },
                    { text: 'üí∞ 50 Coins', highlight: true }
                ];

                rewards.forEach(reward => {
                    const item = document.createElement('div');
                    item.className = reward.highlight ? 'reward-item highlight' : 'reward-item';
                    item.textContent = reward.text;
                    rewardsList.appendChild(item);
                });

                const playerRef = ref(database, `players/${currentPlayer}`);
                const snapshot = await get(playerRef);
                let playerData = snapshot.val() || { coins: 0, team: [] };
                playerData.coins = (playerData.coins || 0) + 50;
                await set(playerRef, playerData);

            } else {
                const rewards = [
                    { text: 'üé∞ 1 Spin dal Pool C', highlight: false },
                    { text: 'üí∞ 25 Coins', highlight: false }
                ];

                rewards.forEach(reward => {
                    const item = document.createElement('div');
                    item.className = 'reward-item';
                    item.textContent = reward.text;
                    rewardsList.appendChild(item);
                });

                const playerRef = ref(database, `players/${currentPlayer}`);
                const snapshot = await get(playerRef);
                let playerData = snapshot.val() || { coins: 0, team: [] };
                playerData.coins = (playerData.coins || 0) + 25;
                await set(playerRef, playerData);
            }

            const eventRef = ref(database, 'events/falkner/players');
            const eventSnapshot = await get(eventRef);
            eventSnapshot.forEach((childSnapshot) => {
                if (childSnapshot.val() === currentPlayer) {
                    remove(ref(database, `events/falkner/players/${childSnapshot.key}`));
                }
            });
        }

        window.goHome = function() {
            window.location.href = 'index.html';
        };

        document.getElementById('pokemonInput1').addEventListener('input', (e) => {
            const filtered = filterPokemon(e.target.value);
            showSuggestions(filtered, 1);
        });

        document.getElementById('pokemonInput2').addEventListener('input', (e) => {
            const filtered = filterPokemon(e.target.value);
            showSuggestions(filtered, 2);
        });

        document.getElementById('submitBtn1').addEventListener('click', () => submitPokemon(1));
        document.getElementById('submitBtn2').addEventListener('click', () => submitPokemon(2));

        document.getElementById('pokemonInput1').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !document.getElementById('submitBtn1').disabled) {
                submitPokemon(1);
            }
        });

        document.getElementById('pokemonInput2').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !document.getElementById('submitBtn2').disabled) {
                submitPokemon(2);
            }
        });

        if (!getCurrentPlayer()) {
            alert('Devi impostare il tuo nome dalla home page!');
            window.location.href = 'index.html';
        } else {
            loadPokemonData().then(() => {
                initializeBattle();
            });
        }
    </script>
</body>
</html>
