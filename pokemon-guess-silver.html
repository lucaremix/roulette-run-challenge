<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Silver Challenge - Indovina il Pok√©mon</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
        }

        h1 {
            font-size: 2.5em;
            color: #c0c0c0;
            margin-bottom: 10px;
        }

        .player-info {
            font-size: 1.2em;
            color: #e0e0e0;
            margin-bottom: 10px;
        }

        .attempts-counter {
            font-size: 1.3em;
            color: #ff6b6b;
            font-weight: bold;
        }

        .game-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .hints-panel {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
        }

        .hints-title {
            font-size: 1.8em;
            color: #c0c0c0;
            margin-bottom: 20px;
            text-align: center;
        }

        .hint-item {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .hint-label {
            color: #888;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .hint-value {
            color: #fff;
            font-size: 1.2em;
            font-weight: bold;
        }

        .pokemon-image {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            display: block;
            filter: brightness(0);
        }

        .pokemon-image.revealed {
            filter: brightness(1);
        }

        .guess-panel {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
        }

        .guess-title {
            font-size: 1.8em;
            color: #c0c0c0;
            margin-bottom: 20px;
            text-align: center;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1.1em;
        }

        .search-input:focus {
            outline: none;
            border-color: #c0c0c0;
        }

        .pokemon-suggestions {
            max-height: 300px;
            overflow-y: auto;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            margin-top: 10px;
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid #1a1a1a;
        }

        .suggestion-item:hover {
            background: #1a1a1a;
        }

        .guess-btn {
            width: 100%;
            padding: 15px;
            background: #c0c0c0;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .guess-btn:hover:not(:disabled) {
            background: #a8a8a8;
            transform: scale(1.02);
        }

        .guess-btn:disabled {
            background: #2a2a2a;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .rewards-panel {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            display: none;
        }

        .rewards-panel.show {
            display: block;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .rewards-title {
            font-size: 2em;
            color: #7fff7f;
            margin-bottom: 20px;
        }

        .rewards-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 20px 0;
        }

        .reward-item {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            color: #e0e0e0;
        }

        .reward-item.highlight {
            background: #2d4a2d;
            border-color: #4a7a4a;
            color: #7fff7f;
            font-weight: bold;
        }

        .home-btn {
            padding: 15px 40px;
            background: #2a7a2a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .home-btn:hover {
            background: #357a35;
        }

        .bonus-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .bonus-badge {
            background: #d4af37;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        @media (max-width: 968px) {
            .game-area {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéØ Silver Challenge</h1>
            <div class="player-info" id="playerInfo">Giocatore: ---</div>
            <div class="attempts-counter" id="attemptsCounter">Tentativi rimasti: 5</div>
        </header>

        <div class="game-area" id="gameArea">
            <div class="hints-panel">
                <h2 class="hints-title">üîç Indizi</h2>
                <div id="hintsContainer">
                    <p style="text-align: center; color: #888; font-style: italic;">
                        Fai il tuo primo tentativo per ricevere gli indizi!
                    </p>
                </div>
                <img id="pokemonImage" class="pokemon-image" style="display: none;" src="" alt="Pokemon">
                <div class="bonus-badges" id="bonusBadges"></div>
            </div>

            <div class="guess-panel">
                <h2 class="guess-title">üí≠ Il tuo tentativo</h2>
                <div class="search-box">
                    <input type="text" 
                           class="search-input" 
                           id="searchInput" 
                           placeholder="Cerca un Pok√©mon..."
                           autocomplete="off">
                    <div class="pokemon-suggestions" id="suggestions" style="display: none;"></div>
                </div>
                <button class="guess-btn" id="guessBtn" onclick="makeGuess()" disabled>
                    Indovina!
                </button>
            </div>
        </div>

        <div class="rewards-panel" id="rewardsPanel">
            <h2 class="rewards-title">üéâ Complimenti!</h2>
            <img id="rewardPokemonImage" style="width: 200px; height: 200px; margin: 20px auto; display: block;" src="" alt="Pokemon">
            <div class="rewards-list" id="rewardsList"></div>
            <button class="home-btn" onclick="goHome()">üè† Torna alla Home</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, get, set, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDNuD9wViLLxteHMCEBlvfdONwcZbAjAvo",
            authDomain: "roulette-run-challenge.firebaseapp.com",
            databaseURL: "https://roulette-run-challenge-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "roulette-run-challenge",
            storageBucket: "roulette-run-challenge.firebasestorage.app",
            messagingSenderId: "994019156093",
            appId: "1:994019156093:web:9792bdce75c486f589d114"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let bTierPokemon = [];
        let myPokemon = null;
        let attemptsLeft = 5;
        let revealedStats = [];
        let selectedPokemon = null;
        let currentBonuses = {
            attempt1: ['IV Perfette', 'Abilit√† Scelta', '100 Coins', 'Shiny', 'Natura Perfetta'],
            attempt2: ['IV Perfette', '100 Coins', 'Abilit√† Hidden', 'Natura Perfetta'],
            attempt3: ['50 Coins', 'Natura Perfetta'],
            attempt4: ['50 Coins'],
            attempt5: ['10 Coins']
        };

        const statNames = {
            hp: 'HP',
            attack: 'ATK',
            defense: 'DEF',
            sp_attack: 'SPATK',
            sp_defense: 'SPDEF',
            speed: 'SPEED'
        };

        function getCurrentPlayer() {
            return localStorage.getItem('playerName') || '';
        }

        function padNumber(num) {
            return String(num).padStart(3, '0');
        }

        function getPokemonImageUrl(nationalNumber) {
            return `https://www.pokemon.com/static-assets/content-assets/cms2/img/pokedex/full/${padNumber(nationalNumber)}.png`;
        }

        function getGeneration(nationalNumber) {
            if (nationalNumber <= 151) return 1;
            if (nationalNumber <= 251) return 2;
            if (nationalNumber <= 386) return 3;
            if (nationalNumber <= 493) return 4;
            return 5;
        }

        async function loadBTierPool() {
            const poolRef = ref(database, 'pools/b_tier');
            const snapshot = await get(poolRef);
            
            if (snapshot.exists()) {
                const data = snapshot.val();
                bTierPokemon = Object.entries(data).map(([key, pokemon]) => ({
                    key: key,
                    ...pokemon
                }));
            }
        }

        function assignRandomPokemon() {
            if (bTierPokemon.length === 0) return null;
            const randomIndex = Math.floor(Math.random() * bTierPokemon.length);
            return bTierPokemon[randomIndex];
        }

        function getRandomStats(count, exclude = []) {
            const allStats = ['hp', 'attack', 'defense', 'sp_attack', 'sp_defense', 'speed'];
            const available = allStats.filter(s => !exclude.includes(s));
            const selected = [];
            
            while (selected.length < count && available.length > 0) {
                const randomIndex = Math.floor(Math.random() * available.length);
                selected.push(available.splice(randomIndex, 1)[0]);
            }
            
            return selected;
        }

        function getRandomWeakness(pokemon) {
            const weaknesses = [];
            const typeEffectiveness = {
                'against_normal': 'Normale',
                'against_fire': 'Fuoco',
                'against_water': 'Acqua',
                'against_electric': 'Elettro',
                'against_grass': 'Erba',
                'against_ice': 'Ghiaccio',
                'against_fighting': 'Lotta',
                'against_poison': 'Veleno',
                'against_ground': 'Terra',
                'against_flying': 'Volante',
                'against_psychic': 'Psico',
                'against_bug': 'Coleottero',
                'against_rock': 'Roccia',
                'against_ghost': 'Spettro',
                'against_dragon': 'Drago',
                'against_dark': 'Buio',
                'against_steel': 'Acciaio',
                'against_fairy': 'Folletto'
            };

            for (const [key, name] of Object.entries(typeEffectiveness)) {
                if (pokemon[key] && pokemon[key] >= 2) {
                    weaknesses.push(name);
                }
            }

            if (weaknesses.length === 0) return 'Nessuna debolezza 4x o 2x';
            
            const randomIndex = Math.floor(Math.random() * weaknesses.length);
            return weaknesses[randomIndex];
        }

        function updateHints() {
            const container = document.getElementById('hintsContainer');
            container.innerHTML = '';

            revealedStats.forEach(stat => {
                const hintDiv = document.createElement('div');
                hintDiv.className = 'hint-item';
                hintDiv.innerHTML = `
                    <div class="hint-label">${stat.label}</div>
                    <div class="hint-value">${stat.value}</div>
                `;
                container.appendChild(hintDiv);
            });

            // Update bonus badges
            const bonusContainer = document.getElementById('bonusBadges');
            bonusContainer.innerHTML = '';
            
            const currentAttempt = 6 - attemptsLeft;
            let bonuses = [];
            
            if (currentAttempt >= 1) bonuses = [...currentBonuses.attempt1];
            if (currentAttempt >= 2) bonuses = currentBonuses.attempt2;
            if (currentAttempt >= 3) bonuses = currentBonuses.attempt3;
            if (currentAttempt >= 4) bonuses = currentBonuses.attempt4;
            if (currentAttempt >= 5) bonuses = currentBonuses.attempt5;

            bonuses.forEach(bonus => {
                const badge = document.createElement('div');
                badge.className = 'bonus-badge';
                badge.textContent = `‚ú® ${bonus}`;
                bonusContainer.appendChild(badge);
            });
        }

        function revealHint(attemptNumber) {
            if (attemptNumber === 1) {
                // Reveal 2 random stats
                const stats = getRandomStats(2);
                stats.forEach(stat => {
                    revealedStats.push({
                        label: statNames[stat],
                        value: myPokemon[stat]
                    });
                });
            } else if (attemptNumber === 2) {
                // Reveal 2 more stats + weakness
                const stats = getRandomStats(2, revealedStats.map(s => 
                    Object.keys(statNames).find(key => statNames[key] === s.label)
                ));
                stats.forEach(stat => {
                    revealedStats.push({
                        label: statNames[stat],
                        value: myPokemon[stat]
                    });
                });
                
                const weakness = getRandomWeakness(myPokemon);
                revealedStats.push({
                    label: 'Debolezza',
                    value: weakness
                });
            } else if (attemptNumber === 3) {
                // Reveal last 2 stats + generation
                const stats = getRandomStats(2, revealedStats.map(s => 
                    Object.keys(statNames).find(key => statNames[key] === s.label)
                ));
                stats.forEach(stat => {
                    revealedStats.push({
                        label: statNames[stat],
                        value: myPokemon[stat]
                    });
                });
                
                const gen = getGeneration(myPokemon.national_number);
                revealedStats.push({
                    label: 'Generazione',
                    value: gen
                });
            } else if (attemptNumber === 4) {
                // Reveal types
                let types = myPokemon.primary_type;
                if (myPokemon.secondary_type) {
                    types += ' / ' + myPokemon.secondary_type;
                }
                revealedStats.push({
                    label: 'Tipo',
                    value: types.charAt(0).toUpperCase() + types.slice(1)
                });
            } else if (attemptNumber === 5) {
                // Reveal image
                const img = document.getElementById('pokemonImage');
                img.src = getPokemonImageUrl(myPokemon.national_number);
                img.style.display = 'block';
                img.classList.add('revealed');
            }

            updateHints();
        }

        function filterPokemon(searchText) {
            if (!searchText) return [];
            
            const search = searchText.toLowerCase();
            return bTierPokemon
                .filter(p => p.english_name.toLowerCase().includes(search))
                .slice(0, 10);
        }

        function showSuggestions(pokemon) {
            const container = document.getElementById('suggestions');
            
            if (pokemon.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.innerHTML = pokemon.map(p => `
                <div class="suggestion-item" onclick="selectPokemon('${p.english_name}', ${p.national_number})">
                    #${padNumber(p.national_number)} - ${p.english_name}
                </div>
            `).join('');
            
            container.style.display = 'block';
        }

        window.selectPokemon = function(name, nationalNumber) {
            selectedPokemon = { name, nationalNumber };
            document.getElementById('searchInput').value = name;
            document.getElementById('suggestions').style.display = 'none';
            document.getElementById('guessBtn').disabled = false;
        };

        window.makeGuess = async function() {
            if (!selectedPokemon) return;

            const isCorrect = selectedPokemon.name === myPokemon.english_name;

            if (isCorrect) {
                // WIN!
                await handleWin();
            } else {
                // Wrong guess
                attemptsLeft--;
                document.getElementById('attemptsCounter').textContent = `Tentativi rimasti: ${attemptsLeft}`;

                if (attemptsLeft === 0) {
                    // Lost all attempts
                    alert(`Hai esaurito i tentativi! Il Pok√©mon era: ${myPokemon.english_name}`);
                    await handleLoss();
                } else {
                    // Reveal new hint
                    const attemptNumber = 6 - attemptsLeft;
                    revealHint(attemptNumber);
                    
                    // Reset selection
                    selectedPokemon = null;
                    document.getElementById('searchInput').value = '';
                    document.getElementById('guessBtn').disabled = true;
                }
            }
        };

        async function handleWin() {
            const attemptNumber = 6 - attemptsLeft;
            let rewards = [];
            let coins = 0;

            // Determine rewards based on attempt number
            if (attemptNumber === 1) {
                rewards = ['IV Perfette', 'Abilit√† Scelta', 'Shiny', 'Natura Perfetta'];
                coins = 100;
            } else if (attemptNumber === 2) {
                rewards = ['IV Perfette', 'Abilit√† Hidden', 'Natura Perfetta'];
                coins = 100;
            } else if (attemptNumber === 3) {
                rewards = ['Natura Perfetta'];
                coins = 50;
            } else if (attemptNumber === 4) {
                coins = 50;
            } else if (attemptNumber === 5) {
                coins = 10;
            }

            // Add pokemon to team
            const player = getCurrentPlayer();
            const playerRef = ref(database, `players/${player}`);
            const playerSnapshot = await get(playerRef);
            
            let playerData = playerSnapshot.val() || { coins: 0, team: [] };
            if (!playerData.team) playerData.team = [];

            // Determine nature and ability
            const nature = rewards.includes('Natura Perfetta') ? 'Adamant' : 'Hardy'; // Example
            const ability = rewards.includes('Abilit√† Hidden') ? myPokemon.abilities_hidden : 
                           rewards.includes('Abilit√† Scelta') ? myPokemon.abilities_0 : 
                           myPokemon.abilities_0;

            playerData.team.push({
                ...myPokemon,
                nature: nature,
                ability: ability,
                shiny: rewards.includes('Shiny'),
                perfect_ivs: rewards.includes('IV Perfette'),
                won_from: 'silver',
                won_at: Date.now()
            });

            playerData.coins = (playerData.coins || 0) + coins;

            await set(playerRef, playerData);

            // Remove pokemon from pool
            const pokemonRef = ref(database, `pools/b_tier/${myPokemon.key}`);
            await remove(pokemonRef);

            // Remove player from event
            const eventRef = ref(database, `events/silver/players`);
            const eventSnapshot = await get(eventRef);
            
            eventSnapshot.forEach((childSnapshot) => {
                if (childSnapshot.val() === player) {
                    remove(ref(database, `events/silver/players/${childSnapshot.key}`));
                }
            });

            // Show rewards
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('rewardPokemonImage').src = getPokemonImageUrl(myPokemon.national_number);
            
            // Add pokemon name display
            const rewardsTitle = document.querySelector('.rewards-title');
            rewardsTitle.textContent = `üéâ Hai indovinato: ${myPokemon.english_name}!`;
            
            const rewardsList = document.getElementById('rewardsList');
            rewardsList.innerHTML = '';

            if (coins > 0) {
                const coinReward = document.createElement('div');
                coinReward.className = 'reward-item highlight';
                coinReward.textContent = `üí∞ ${coins} Coins`;
                rewardsList.appendChild(coinReward);
            }

            rewards.forEach(reward => {
                const rewardDiv = document.createElement('div');
                rewardDiv.className = 'reward-item';
                rewardDiv.textContent = `‚ú® ${reward}`;
                rewardsList.appendChild(rewardDiv);
            });

            document.getElementById('rewardsPanel').classList.add('show');
        }

        async function handleLoss() {
            // Just remove player from event and go home
            const player = getCurrentPlayer();
            const eventRef = ref(database, `events/silver/players`);
            const eventSnapshot = await get(eventRef);
            
            eventSnapshot.forEach((childSnapshot) => {
                if (childSnapshot.val() === player) {
                    remove(ref(database, `events/silver/players/${childSnapshot.key}`));
                }
            });

            setTimeout(() => {
                window.location.href = 'index.html';
            }, 2000);
        }

        window.goHome = function() {
            window.location.href = 'index.html';
        };

        // Setup search input
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const filtered = filterPokemon(e.target.value);
            showSuggestions(filtered);
        });

        document.getElementById('searchInput').addEventListener('blur', () => {
            setTimeout(() => {
                document.getElementById('suggestions').style.display = 'none';
            }, 200);
        });

        // Initialize
        const playerName = getCurrentPlayer();
        if (!playerName) {
            alert('Devi impostare il tuo nome dalla home page!');
            window.location.href = 'index.html';
        } else {
            document.getElementById('playerInfo').textContent = `Giocatore: ${playerName}`;
            
            loadBTierPool().then(() => {
                myPokemon = assignRandomPokemon();
                if (!myPokemon) {
                    alert('Errore: Pool B vuoto!');
                    window.location.href = 'index.html';
                }
                console.log('Il tuo Pok√©mon:', myPokemon.english_name); // For debugging
            });
        }
    </script>
</body>
</html>
