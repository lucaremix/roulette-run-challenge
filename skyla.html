<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Skyla - Stat Sorting Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/background/Skyla_background.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #e0e0e0;
            text-decoration: none;
            font-size: 1em;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .back-btn:hover {
            background: #252525;
        }

        .event-header {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .event-trainer-img {
            width: 160px;
            height: 160px;
            object-fit: contain;
            border: none;
            flex-shrink: 0;
            image-rendering: pixelated;
        }

        .event-info {
            flex: 1;
        }

        .event-title {
            font-size: 2.5em;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .event-status {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .status-badge {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .status-badge.joined {
            background: #2d4a2d;
            color: #7fff7f;
        }

        .status-badge.not-joined {
            background: #2a2a2a;
            color: #888;
        }

        .join-leave-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .join-btn {
            background: #2a7a2a;
            color: white;
        }

        .join-btn:hover {
            background: #357a35;
        }

        .leave-btn {
            background: #7a2a2a;
            color: white;
        }

        .leave-btn:hover {
            background: #8a3535;
        }

        .players-section {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .players-title {
            font-size: 1.8em;
            color: #ffffff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-count-badge {
            background: #2a2a2a;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.7em;
            color: #888;
        }

        .players-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-card {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-card.current-user {
            border-color: #4a4a4a;
            background: #1f1f1f;
        }

        .player-name {
            font-size: 1.1em;
            color: #e0e0e0;
        }

        .player-card.current-user .player-name {
            color: #ffffff;
            font-weight: 600;
        }

        .you-badge {
            background: #2a7a2a;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .no-players {
            text-align: center;
            color: #555;
            font-style: italic;
            padding: 30px;
        }

        .intro-screen {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 40px;
            display: none;
        }

        .intro-screen.show {
            display: block;
        }

        .intro-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .intro-text h2 {
            font-size: 2em;
            color: #87CEEB;
            margin-bottom: 20px;
            text-align: center;
        }

        .intro-text p {
            font-size: 1.2em;
            line-height: 1.8;
            color: #e0e0e0;
            margin-bottom: 15px;
        }

        .intro-text .highlight {
            color: #87CEEB;
            font-weight: bold;
        }

        .start-btn {
            display: block;
            margin: 30px auto 0;
            padding: 20px 60px;
            background: #87CEEB;
            color: #1a1a1a;
            border: none;
            border-radius: 8px;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .start-btn:hover {
            background: #6FB5D9;
            transform: scale(1.05);
        }

        .game-area {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            display: none;
        }

        .game-area.show {
            display: block;
        }

        .score-section {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 20px;
            background: #0a0a0a;
            border-radius: 8px;
        }

        .player-score {
            text-align: center;
        }

        .player-score h3 {
            font-size: 1.3em;
            color: #87CEEB;
            margin-bottom: 10px;
        }

        .score-display {
            font-size: 2em;
            color: #ffffff;
            font-weight: bold;
        }

        .round-info {
            text-align: center;
            margin-bottom: 30px;
        }

        .round-number {
            font-size: 1.5em;
            color: #87CEEB;
            margin-bottom: 10px;
        }

        .stat-challenge {
            font-size: 1.8em;
            color: #ffffff;
            font-weight: bold;
        }

        .pokemon-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .pokemon-card {
            background: #0a0a0a;
            border: 2px solid #2a2a2a;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: grab;
        }

        .pokemon-card:active {
            cursor: grabbing;
        }

        .pokemon-card.dragging {
            opacity: 0.5;
        }

        .pokemon-card.drag-over {
            border-color: #87CEEB;
            background: #1a2a3a;
        }

        .pokemon-img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 10px;
        }

        .pokemon-name {
            font-size: 1.1em;
            color: #ffffff;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .pokemon-stat {
            font-size: 1.5em;
            color: #87CEEB;
            font-weight: bold;
        }

        .sort-instructions {
            text-align: center;
            font-size: 1.2em;
            color: #e0e0e0;
            margin-bottom: 20px;
        }

        .submit-order-btn {
            display: block;
            margin: 0 auto;
            padding: 15px 50px;
            background: #87CEEB;
            color: #1a1a1a;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .submit-order-btn:hover {
            background: #6FB5D9;
            transform: scale(1.05);
        }

        .submit-order-btn:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }

        .waiting-screen {
            text-align: center;
            padding: 50px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            display: none;
        }

        .waiting-screen.show {
            display: block;
        }

        .waiting-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #2a2a2a;
            border-top: 4px solid #87CEEB;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .waiting-text {
            font-size: 1.3em;
            color: #e0e0e0;
        }

        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .result-overlay.show {
            display: flex;
        }

        .result-content {
            background: #1a1a1a;
            border: 2px solid #87CEEB;
            border-radius: 12px;
            padding: 40px;
            max-width: 800px;
            text-align: center;
        }

        .result-title {
            font-size: 2.5em;
            color: #87CEEB;
            margin-bottom: 30px;
        }

        .correct-order {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .order-card {
            background: #0a0a0a;
            border: 2px solid #2a2a2a;
            border-radius: 8px;
            padding: 15px;
        }

        .order-card.correct {
            border-color: #7fff7f;
        }

        .order-card.wrong {
            border-color: #ff6464;
        }

        .order-position {
            font-size: 1.2em;
            color: #87CEEB;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .scores-comparison {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            padding: 20px;
            background: #0a0a0a;
            border-radius: 8px;
        }

        .player-result {
            text-align: center;
        }

        .player-result h4 {
            font-size: 1.3em;
            color: #e0e0e0;
            margin-bottom: 10px;
        }

        .correct-count {
            font-size: 2em;
            font-weight: bold;
        }

        .correct-count.winner {
            color: #7fff7f;
        }

        .correct-count.loser {
            color: #ff6464;
        }

        .final-result {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            display: none;
        }

        .final-result.show {
            display: block;
        }

        .winner-text {
            font-size: 3em;
            color: #87CEEB;
            margin-bottom: 30px;
            font-weight: bold;
        }

        .final-scores {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin-bottom: 30px;
        }

        .final-score-card {
            background: #0a0a0a;
            border: 2px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            min-width: 200px;
        }

        .final-score-card.winner {
            border-color: #7fff7f;
        }

        .rewards-section {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .reward-item {
            padding: 15px;
            margin: 10px 0;
            background: #1a1a1a;
            border-radius: 8px;
            font-size: 1.2em;
        }

        .spin-btn {
            padding: 20px 60px;
            background: #87CEEB;
            color: #1a1a1a;
            border: none;
            border-radius: 8px;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .spin-btn:hover {
            background: #6FB5D9;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">← Torna alla Home</a>

        <!-- Event Header -->
        <div class="event-header">
            <img src="https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/trainers/Skyla.png" 
                 alt="Skyla" class="event-trainer-img">
            <div class="event-info">
                <h1 class="event-title">Skyla - Stat Sorting Challenge</h1>
                <p style="font-size: 1.1em; color: #e0e0e0; margin-bottom: 15px;">
                    Ordina 5 Pokémon casuali in base alla loro statistica. Chi indovina più posizioni corrette vince il round!
                </p>
                <div class="event-status">
                    <div id="statusBadge" class="status-badge not-joined">Non Iscritto</div>
                    <button id="joinLeaveBtn" class="join-leave-btn join-btn" onclick="toggleJoin()">Iscriviti</button>
                </div>
            </div>
        </div>

        <!-- Players Section -->
        <div id="playersSection" class="players-section">
            <div class="players-title">
                Giocatori Iscritti
                <span id="playerCount" class="player-count-badge">0/2</span>
            </div>
            <div id="playersList" class="players-list">
                <div class="no-players">Nessun giocatore iscritto</div>
            </div>
        </div>

        <!-- Intro Screen -->
        <div id="introScreen" class="intro-screen">
            <div class="intro-content">
                <div class="intro-text">
                    <h2>Benvenuto alla Skyla Challenge!</h2>
                    <p>In questa sfida ti verranno mostrati <span class="highlight">5 Pokémon casuali</span> e una <span class="highlight">statistica specifica</span> (HP, Attack, Sp. Attack, Defense o Speed).</p>
                    <p>Il tuo obiettivo è <span class="highlight">ordinare i Pokémon dal più alto al più basso</span> in quella statistica.</p>
                    <p>Ogni posizione corretta ti fa guadagnare <span class="highlight">1 punto</span>. Chi ottiene più punti vince il round!</p>
                    <p>Il <span class="highlight">primo a vincere 5 round</span> vince la sfida e ottiene ricompense migliori!</p>
                    <p style="margin-top: 25px; color: #87CEEB; font-size: 1.1em;">
                        🏆 Vincitore: 1 Spin A Tier + 150 Coins<br>
                        💰 Perdente: 1 Spin B Tier + 100 Coins
                    </p>
                </div>
                <button class="start-btn" onclick="startGame()">Inizia la Sfida!</button>
            </div>
        </div>

        <!-- Game Area -->
        <div id="gameArea" class="game-area">
            <div class="score-section">
                <div class="player-score">
                    <h3 id="player1Name">Player 1</h3>
                    <div class="score-display" id="player1Score">0</div>
                </div>
                <div class="player-score">
                    <h3 id="player2Name">Player 2</h3>
                    <div class="score-display" id="player2Score">0</div>
                </div>
            </div>

            <div class="round-info">
                <div class="round-number" id="roundNumber">Round 1</div>
                <div class="stat-challenge" id="statChallenge">Ordina per: HP</div>
            </div>

            <div class="sort-instructions">
                Trascina i Pokémon per ordinarli dal più alto al più basso ⬇️
            </div>

            <div id="pokemonGrid" class="pokemon-grid">
                <!-- Pokemon cards will be inserted here -->
            </div>

            <button class="submit-order-btn" onclick="submitOrder()">Conferma Ordine</button>
        </div>

        <!-- Waiting Screen -->
        <div id="waitingScreen" class="waiting-screen">
            <div class="waiting-spinner"></div>
            <div class="waiting-text" id="waitingText">In attesa dell'altro giocatore...</div>
        </div>

        <!-- Result Overlay -->
        <div id="resultOverlay" class="result-overlay">
            <div class="result-content">
                <h2 class="result-title">Risultati Round</h2>
                <div class="correct-order" id="correctOrder">
                    <!-- Correct order will be shown here -->
                </div>
                <div class="scores-comparison" id="scoresComparison">
                    <!-- Player scores comparison -->
                </div>
            </div>
        </div>

        <!-- Final Result -->
        <div id="finalResult" class="final-result">
            <div class="winner-text" id="winnerText">Player X ha vinto!</div>
            <div class="final-scores">
                <div class="final-score-card winner">
                    <h3 id="finalPlayer1Name">Player 1</h3>
                    <div class="score-display" id="finalPlayer1Score">0</div>
                </div>
                <div class="final-score-card">
                    <h3 id="finalPlayer2Name">Player 2</h3>
                    <div class="score-display" id="finalPlayer2Score">0</div>
                </div>
            </div>
            <div class="rewards-section" id="rewardsDiv">
                <!-- Rewards will be shown here -->
            </div>
            <button class="spin-btn" onclick="goToSpin()">Vai agli Spin! 🎰</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, set, get, onValue, update } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDR8klOet_gmF2KKeccKL7TaEEBlBCRR8Q",
            authDomain: "roulette-run-challenge.firebaseapp.com",
            databaseURL: "https://roulette-run-challenge-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "roulette-run-challenge",
            storageBucket: "roulette-run-challenge.firebasestorage.app",
            messagingSenderId: "690530356038",
            appId: "1:690530356038:web:3a0c60e91f1a9e2bad2094"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const eventRef = ref(database, 'events/skyla');

        let allPokemon = [];
        let gameState = null;
        let currentOrder = [];
        let draggedElement = null;

        function getCurrentPlayer() {
            return localStorage.getItem('playerName');
        }

        async function loadPokemonData() {
            try {
                const response = await fetch('pokemon.json');
                allPokemon = await response.json();
            } catch (error) {
                console.error('Error loading Pokemon data:', error);
            }
        }

        function padNumber(num) {
            return String(num).padStart(3, '0');
        }

        async function renderLanding() {
            const snapshot = await get(eventRef);
            const state = snapshot.val();

            const currentPlayer = getCurrentPlayer();
            const players = state?.players || {};
            const playerNames = Object.keys(players);

            // Update status badge
            const isJoined = playerNames.includes(currentPlayer);
            const statusBadge = document.getElementById('statusBadge');
            const joinLeaveBtn = document.getElementById('joinLeaveBtn');

            if (isJoined) {
                statusBadge.textContent = 'Iscritto';
                statusBadge.className = 'status-badge joined';
                joinLeaveBtn.textContent = 'Abbandona';
                joinLeaveBtn.className = 'join-leave-btn leave-btn';
            } else {
                statusBadge.textContent = 'Non Iscritto';
                statusBadge.className = 'status-badge not-joined';
                joinLeaveBtn.textContent = 'Iscriviti';
                joinLeaveBtn.className = 'join-leave-btn join-btn';
            }

            // Update players list
            document.getElementById('playerCount').textContent = `${playerNames.length}/2`;
            const playersList = document.getElementById('playersList');

            if (playerNames.length === 0) {
                playersList.innerHTML = '<div class="no-players">Nessun giocatore iscritto</div>';
            } else {
                playersList.innerHTML = playerNames.map(name => {
                    const isCurrentUser = name === currentPlayer;
                    return `
                        <div class="player-card ${isCurrentUser ? 'current-user' : ''}">
                            <span class="player-name">${name}</span>
                            ${isCurrentUser ? '<span class="you-badge">Tu</span>' : ''}
                        </div>
                    `;
                }).join('');
            }

            // Show intro or game based on state
            if (state?.isActive && playerNames.includes(currentPlayer)) {
                document.getElementById('playersSection').style.display = 'none';
                if (state.isGameOver) {
                    showFinalResult(state);
                } else if (state.showRoundResult) {
                    showRoundResult(state);
                } else {
                    document.getElementById('introScreen').classList.add('show');
                }
            }
        }

        window.toggleJoin = async function() {
            const currentPlayer = getCurrentPlayer();
            const snapshot = await get(eventRef);
            let state = snapshot.val() || { players: {} };

            const players = state.players || {};
            const playerNames = Object.keys(players);

            if (playerNames.includes(currentPlayer)) {
                // Leave
                delete players[currentPlayer];
                state.players = players;

                // Reset game if someone leaves
                if (state.isActive) {
                    state = { players: state.players };
                }
            } else {
                // Join
                if (playerNames.length >= 2) {
                    alert('La sfida è piena! Solo 2 giocatori possono partecipare.');
                    return;
                }
                players[currentPlayer] = { ready: false };
                state.players = players;
            }

            await set(eventRef, state);
            renderLanding();
        };

        window.startGame = async function() {
            const snapshot = await get(eventRef);
            let state = snapshot.val();

            if (!state || !state.players) {
                alert('Errore: nessun giocatore registrato.');
                return;
            }

            const playerNames = Object.keys(state.players);
            if (playerNames.length !== 2) {
                alert('Servono esattamente 2 giocatori per iniziare!');
                return;
            }

            if (!state.isActive) {
                // Initialize game
                state.isActive = true;
                state.currentRound = 1;
                state.roundsToWin = 5;
                state.player1 = { name: playerNames[0], score: 0 };
                state.player2 = { name: playerNames[1], score: 0 };
                
                await generateNewRound(state);
            } else {
                // Resume game
                document.getElementById('introScreen').classList.remove('show');
                renderGameArea(state);
            }
        };

        async function generateNewRound(state) {
            // Select 5 random pokemon
            const shuffled = [...allPokemon].sort(() => Math.random() - 0.5);
            const selectedPokemon = shuffled.slice(0, 5);

            // Select random stat
            const stats = ['hp', 'attack', 'sp_attack', 'defense', 'speed'];
            const statNames = {
                'hp': 'HP',
                'attack': 'Attack',
                'sp_attack': 'Sp. Attack',
                'defense': 'Defense',
                'speed': 'Speed'
            };
            const selectedStat = stats[Math.floor(Math.random() * stats.length)];

            // Sort pokemon by the selected stat (highest to lowest)
            const correctOrder = selectedPokemon
                .map(p => ({
                    name: p.english_name,
                    national_number: p.national_number,
                    stat: parseInt(p[selectedStat])
                }))
                .sort((a, b) => b.stat - a.stat);

            // Shuffle pokemon for display
            const displayOrder = [...correctOrder].sort(() => Math.random() - 0.5);

            state.currentPokemon = displayOrder;
            state.correctOrder = correctOrder;
            state.selectedStat = selectedStat;
            state.selectedStatName = statNames[selectedStat];
            state.submissions = {};
            delete state.showRoundResult;

            await set(eventRef, state);
            
            document.getElementById('introScreen').classList.remove('show');
            renderGameArea(state);
        }

        function renderGameArea(state) {
            gameState = state;
            document.getElementById('gameArea').classList.add('show');
            document.getElementById('playersSection').style.display = 'none';

            // Update scores
            document.getElementById('player1Name').textContent = state.player1.name;
            document.getElementById('player1Score').textContent = state.player1.score;
            document.getElementById('player2Name').textContent = state.player2.name;
            document.getElementById('player2Score').textContent = state.player2.score;

            // Update round info
            document.getElementById('roundNumber').textContent = `Round ${state.currentRound}`;
            document.getElementById('statChallenge').textContent = `Ordina per: ${state.selectedStatName}`;

            // Render pokemon grid
            currentOrder = [...state.currentPokemon];
            renderPokemonGrid();
        }

        function renderPokemonGrid() {
            const grid = document.getElementById('pokemonGrid');
            grid.innerHTML = currentOrder.map((pokemon, index) => {
                const imgUrl = `https://www.pokemon.com/static-assets/content-assets/cms2/img/pokedex/full/${padNumber(pokemon.national_number)}.png`;
                return `
                    <div class="pokemon-card" draggable="true" data-index="${index}">
                        <img src="${imgUrl}" alt="${pokemon.name}" class="pokemon-img">
                        <div class="pokemon-name">${pokemon.name}</div>
                        <div class="pokemon-stat">${pokemon.stat}</div>
                    </div>
                `;
            }).join('');

            // Add drag and drop listeners
            const cards = grid.querySelectorAll('.pokemon-card');
            cards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
            });
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            const afterElement = getDragAfterElement(this.parentElement, e.clientX);
            if (afterElement == null) {
                this.parentElement.appendChild(draggedElement);
            } else {
                this.parentElement.insertBefore(draggedElement, afterElement);
            }
            
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            const draggedIndex = parseInt(draggedElement.dataset.index);
            const targetIndex = parseInt(this.dataset.index);
            
            if (draggedIndex !== targetIndex) {
                // Swap in currentOrder array
                const temp = currentOrder[draggedIndex];
                currentOrder[draggedIndex] = currentOrder[targetIndex];
                currentOrder[targetIndex] = temp;
                
                // Re-render grid
                renderPokemonGrid();
            }
            
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            const cards = document.querySelectorAll('.pokemon-card');
            cards.forEach(card => {
                card.classList.remove('drag-over');
            });
        }

        function getDragAfterElement(container, x) {
            const draggableElements = [...container.querySelectorAll('.pokemon-card:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = x - box.left - box.width / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        window.submitOrder = async function() {
            const currentPlayer = getCurrentPlayer();
            const snapshot = await get(eventRef);
            const state = snapshot.val();

            if (!state.submissions) {
                state.submissions = {};
            }

            // Save player's order
            state.submissions[currentPlayer] = currentOrder.map(p => p.name);
            await set(eventRef, state);

            // Hide game area and show waiting screen
            document.getElementById('gameArea').classList.remove('show');
            document.getElementById('waitingScreen').classList.add('show');

            // Check if both players submitted
            const playerNames = [state.player1.name, state.player2.name];
            if (playerNames.every(name => state.submissions[name])) {
                // Calculate scores
                await calculateRoundScores(state);
            }
        };

        async function calculateRoundScores(state) {
            const player1Order = state.submissions[state.player1.name];
            const player2Order = state.submissions[state.player2.name];
            const correctNames = state.correctOrder.map(p => p.name);

            let player1Correct = 0;
            let player2Correct = 0;

            for (let i = 0; i < correctNames.length; i++) {
                if (player1Order[i] === correctNames[i]) player1Correct++;
                if (player2Order[i] === correctNames[i]) player2Correct++;
            }

            // Determine round winner
            if (player1Correct > player2Correct) {
                state.player1.score++;
            } else if (player2Correct > player1Correct) {
                state.player2.score++;
            }
            // If tied, no one gets a point

            state.roundResults = {
                player1Correct,
                player2Correct,
                player1Order,
                player2Order
            };

            state.showRoundResult = true;

            // Check if game is over
            if (state.player1.score >= state.roundsToWin || state.player2.score >= state.roundsToWin) {
                state.isGameOver = true;
                await giveRewards(state);
            }

            await set(eventRef, state);
        }

        function showRoundResult(state) {
            document.getElementById('waitingScreen').classList.remove('show');
            document.getElementById('resultOverlay').classList.add('show');

            const correctOrder = document.getElementById('correctOrder');
            const currentPlayer = getCurrentPlayer();
            const playerOrder = state.roundResults[currentPlayer === state.player1.name ? 'player1Order' : 'player2Order'];

            correctOrder.innerHTML = state.correctOrder.map((pokemon, index) => {
                const isCorrect = playerOrder[index] === pokemon.name;
                const imgUrl = `https://www.pokemon.com/static-assets/content-assets/cms2/img/pokedex/full/${padNumber(pokemon.national_number)}.png`;
                
                return `
                    <div class="order-card ${isCorrect ? 'correct' : 'wrong'}">
                        <div class="order-position">#${index + 1}</div>
                        <img src="${imgUrl}" alt="${pokemon.name}" class="pokemon-img">
                        <div class="pokemon-name">${pokemon.name}</div>
                        <div class="pokemon-stat">${pokemon.stat}</div>
                    </div>
                `;
            }).join('');

            const scoresComparison = document.getElementById('scoresComparison');
            const p1Correct = state.roundResults.player1Correct;
            const p2Correct = state.roundResults.player2Correct;
            const winner = p1Correct > p2Correct ? state.player1.name : (p2Correct > p1Correct ? state.player2.name : null);

            scoresComparison.innerHTML = `
                <div class="player-result">
                    <h4>${state.player1.name}</h4>
                    <div class="correct-count ${winner === state.player1.name ? 'winner' : 'loser'}">${p1Correct}/5</div>
                </div>
                <div class="player-result">
                    <h4>${state.player2.name}</h4>
                    <div class="correct-count ${winner === state.player2.name ? 'winner' : 'loser'}">${p2Correct}/5</div>
                </div>
            `;

            setTimeout(async () => {
                document.getElementById('resultOverlay').classList.remove('show');
                
                if (state.isGameOver) {
                    showFinalResult(state);
                } else {
                    // Start new round
                    state.currentRound++;
                    await generateNewRound(state);
                }
            }, 5000);
        }

        function showFinalResult(state) {
            document.getElementById('finalResult').classList.add('show');
            document.getElementById('gameArea').classList.remove('show');
            document.getElementById('playersSection').style.display = 'none';

            const winner = state.player1.score >= state.roundsToWin ? state.player1 : state.player2;
            const loser = winner === state.player1 ? state.player2 : state.player1;

            document.getElementById('winnerText').textContent = `${winner.name} ha vinto!`;
            document.getElementById('finalPlayer1Name').textContent = state.player1.name;
            document.getElementById('finalPlayer1Score').textContent = state.player1.score;
            document.getElementById('finalPlayer2Name').textContent = state.player2.name;
            document.getElementById('finalPlayer2Score').textContent = state.player2.score;

            document.getElementById('rewardsDiv').innerHTML = `
                <h3 style="color: #87CEEB; margin-bottom: 15px;">Ricompense</h3>
                <div class="reward-item">🏆 ${winner.name}: 1 Spin Pool A + 150 Coins</div>
                <div class="reward-item">💰 ${loser.name}: 1 Spin Pool B + 100 Coins</div>
            `;
        }

        async function giveRewards(state) {
            const winner = state.player1.score >= state.roundsToWin ? state.player1.name : state.player2.name;
            const loser = winner === state.player1.name ? state.player2.name : state.player1.name;

            const winnerRef = ref(database, `players/${winner}`);
            const loserRef = ref(database, `players/${loser}`);

            const winnerSnap = await get(winnerRef);
            const loserSnap = await get(loserRef);

            let winnerData = winnerSnap.val() || { coins: 0, team: [] };
            let loserData = loserSnap.val() || { coins: 0, team: [] };

            winnerData.coins = (winnerData.coins || 0) + 150;
            winnerData.pendingSpin = { pool: 'a-tier', from: 'skyla' };

            loserData.coins = (loserData.coins || 0) + 100;
            loserData.pendingSpin = { pool: 'b-tier', from: 'skyla' };

            await set(winnerRef, winnerData);
            await set(loserRef, loserData);
        }

        window.goToSpin = function() {
            window.location.href = 'pokemon-spin.html';
        };

        // Listen for state changes
        onValue(eventRef, (snapshot) => {
            const state = snapshot.val();
            if (state) {
                const currentPlayer = getCurrentPlayer();
                const playerNames = state.players ? Object.keys(state.players) : [];
                
                if (state.isActive && playerNames.includes(currentPlayer)) {
                    if (state.isGameOver && !document.getElementById('finalResult').classList.contains('show')) {
                        showFinalResult(state);
                    } else if (state.showRoundResult && !document.getElementById('resultOverlay').classList.contains('show')) {
                        showRoundResult(state);
                    } else if (!state.showRoundResult && !state.isGameOver && state.currentPokemon) {
                        const hasSubmitted = state.submissions && state.submissions[currentPlayer];
                        if (!hasSubmitted && !document.getElementById('gameArea').classList.contains('show')) {
                            renderGameArea(state);
                        }
                    }
                } else if (!state.isActive || !playerNames.includes(currentPlayer)) {
                    renderLanding();
                }
            }
        });

        if (!getCurrentPlayer()) {
            alert('Devi impostare il tuo nome dalla home page!');
            window.location.href = 'index.html';
        } else {
            loadPokemonData().then(() => {
                renderLanding();
            });
        }
    </script>
</body>
</html>
