<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Items Market - Pok√©mon Roulette Run</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            min-height: 100vh;
            padding: 20px;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #e0e0e0;
            text-decoration: none;
            font-size: 1em;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .back-btn:hover {
            background: #252525;
            border-color: #3a3a3a;
        }

        header {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5em;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .player-coins {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1.5em;
            color: #ffd700;
            margin-bottom: 20px;
        }

        .coin-img {
            width: 32px;
            height: 32px;
            image-rendering: pixelated;
        }

        .section {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 2em;
            color: #ffffff;
            margin-bottom: 20px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .item-card {
            background: #1a1a1a;
            border: 2px solid #2a2a2a;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .item-card:hover {
            border-color: #3a3a3a;
            transform: translateY(-5px);
        }

        .item-card.sold-out {
            opacity: 0.5;
            pointer-events: none;
        }

        .sold-out-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
            background: #c41e3a;
            color: white;
        }

        .item-image {
            width: 100px;
            height: 100px;
            object-fit: contain;
            margin-bottom: 15px;
            image-rendering: pixelated;
        }

        .item-name {
            font-size: 1.8em;
            color: #fff;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .item-description {
            color: #888;
            margin-bottom: 20px;
            min-height: 40px;
        }

        .item-stock {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .item-price {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 1.3em;
            color: #ffd700;
            font-weight: bold;
        }

        .buy-btn {
            width: 100%;
            padding: 12px;
            background: #2a7a2a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .buy-btn:hover:not(:disabled) {
            background: #357a35;
            transform: scale(1.02);
        }

        .buy-btn:disabled {
            background: #2a2a2a;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #888;
            font-size: 1.2em;
        }

        .error {
            background: #c41e3a;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success {
            background: #2a7a2a;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .items-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">
            <span>‚Üê</span>
            Torna alla Home
        </a>

        <header>
            <h1>üõí Items Market</h1>
            <div class="player-coins">
                <img src="https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/pixel-art-red-chinese-gold-coin-png.png" 
                     alt="Coins" 
                     class="coin-img"
                     onerror="this.style.display='none'">
                <span id="playerCoins">0</span>
            </div>
        </header>

        <div id="messageArea"></div>

        <!-- STRUMENTI PERMANENTI -->
        <section class="section">
            <h2 class="section-title">üîí Strumenti Permanenti</h2>
            <div class="items-grid" id="permanentItemsGrid"></div>
        </section>

        <!-- STRUMENTI CONSUMABILI -->
        <section class="section">
            <h2 class="section-title">‚ôæÔ∏è Strumenti Consumabili</h2>
            <div class="items-grid" id="consumableItemsGrid"></div>
        </section>

        <!-- MINTS -->
        <section class="section">
            <h2 class="section-title">üåø Mints (Max 3)</h2>
            <div class="items-grid" id="mintsGrid"></div>
        </section>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, get, set, update } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        // ==================== CONFIGURAZIONE PREZZI ====================
        const PRICES = {
            // Strumenti Permanenti
            'Amulet Coin': 5000,
            'Shiny Charm': 8000,
            'Credit Voucher': 3000,
            'Limit Breaker Ball': 10000,
            'Spray Duck': 4000,
            
            // Strumenti Consumabili
            'Bottle Cap': 1000,
            'Golden Bottle Cap': 5000,
            'Ability Capsule': 2000,
            'Golden Soothe Bell': 1500,
            'Pok√©rus Sludge': 3000,
            'Spin Enhancer Cell': 4000,
            'Lottery Ticket': 2500,
            'Type Avoider Herb': 1800,
            
            // Mints
            'Adamant Mint': 500,
            'Bashful Mint': 500,
            'Bold Mint': 500,
            'Brave Mint': 500,
            'Calm Mint': 500,
            'Careful Mint': 500,
            'Docile Mint': 500,
            'Gentle Mint': 500,
            'Hardy Mint': 500,
            'Hasty Mint': 500,
            'Impish Mint': 500,
            'Jolly Mint': 500,
            'Lax Mint': 500,
            'Lonely Mint': 500,
            'Mild Mint': 500,
            'Modest Mint': 500,
            'Naive Mint': 500,
            'Naughty Mint': 500,
            'Quiet Mint': 500,
            'Quirky Mint': 500,
            'Rash Mint': 500,
            'Relaxed Mint': 500,
            'Sassy Mint': 500,
            'Serious Mint': 500,
            'Timid Mint': 500
        };
        // ===============================================================

        const firebaseConfig = {
            apiKey: "AIzaSyBQpow283Yne3xY88NZHRF”ôlk9TElI8Ey0",
            authDomain: "roulette-run-challenge.firebaseapp.com",
            databaseURL: "https://roulette-run-challenge-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "roulette-run-challenge",
            storageBucket: "roulette-run-challenge.firebasestorage.app",
            messagingSenderId: "155292105112",
            appId: "1:155292105112:web:b00b86bc4ee2fd46f9d8b6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Dati degli items
        const permanentItems = [
            {
                name: 'Amulet Coin',
                description: '+20% coins guadagnati',
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-amuletcoin.png?raw=true',
                type: 'permanent'
            },
            {
                name: 'Shiny Charm',
                description: '3 pokemon invece di 1 Shiny',
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-shinycharm.png?raw=true',
                type: 'permanent'
            },
            {
                name: 'Credit Voucher',
                description: '10% di sconto sul black market',
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-creditvoucher.png?raw=true',
                type: 'permanent'
            },
            {
                name: 'Limit Breaker Ball',
                description: 'I Pok√©mon della squadra possono overcappare di 1 lvl le bossfight',
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-limitbreakerball.png?raw=true',
                type: 'permanent'
            },
            {
                name: 'Spray Duck',
                description: 'Raddoppia la velocit√† di crescita delle bacche',
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-sprayduck.png?raw=true',
                type: 'permanent'
            }
        ];

        const consumableItems = [
            {
                name: 'Bottle Cap',
                description: 'Massimizza una IV stat di un Pok√©mon',
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-bottlecap.png?raw=true',
                type: 'consumable'
            },
            {
                name: 'Golden Bottle Cap',
                description: 'Massimizza tutte le IV stats di un Pok√©mon',
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-goldbottlecap.png?raw=true',
                type: 'consumable'
            },
            {
                name: 'Ability Capsule',
                description: "Cambia l'abilit√† di un Pok√©mon",
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-abilitycapsule.png?raw=true',
                type: 'consumable'
            },
            {
                name: 'Golden Soothe Bell',
                description: 'Massimizza la felicit√† di un Pok√©mon',
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-goldensoothebell.png?raw=true',
                type: 'consumable'
            },
            {
                name: 'Pok√©rus Sludge',
                description: 'Infetta un Pok√©mon con il Pok√©rus',
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-pokerussludge.png?raw=true',
                type: 'consumable'
            },
            {
                name: 'Spin Enhancer Cell',
                description: 'Migliora la qualit√† di uno spin di 1 Tier',
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-spinenhancercell.png?raw=true',
                type: 'consumable'
            },
            {
                name: 'Lottery Ticket',
                description: 'Biglietto per la Roulette Casuale',
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-lotteryticket.webp?raw=true',
                type: 'consumable'
            },
            {
                name: 'Type Avoider Herb',
                description: 'Permette di saltare Pok√©mon di un certo Typing durante uno Spin',
                image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-typeavoiderherb.png?raw=true',
                type: 'consumable'
            }
        ];

        const mints = [
            'Adamant', 'Bashful', 'Bold', 'Brave', 'Calm', 'Careful', 'Docile', 
            'Gentle', 'Hardy', 'Hasty', 'Impish', 'Jolly', 'Lax', 'Lonely', 
            'Mild', 'Modest', 'Naive', 'Naughty', 'Quiet', 'Quirky', 'Rash', 
            'Relaxed', 'Sassy', 'Serious', 'Timid'
        ].map(nature => ({
            name: `${nature} Mint`,
            description: `Cambia la natura del Pok√©mon in ${nature}`,
            image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-mint.png?raw=true',
            type: 'mint',
            maxStock: 3
        }));

        let playerName = localStorage.getItem('playerName');
        let playerData = null;
        let playerInventory = null;

        async function loadPlayerData() {
            if (!playerName) {
                showError('Nessun giocatore selezionato! Torna alla home per selezionare un giocatore.');
                return false;
            }

            try {
                // Carica i dati del giocatore
                const playerRef = ref(db, `players/${playerName}`);
                const snapshot = await get(playerRef);
                
                if (!snapshot.exists()) {
                    showError('Giocatore non trovato nel database!');
                    return false;
                }

                playerData = snapshot.val();
                document.getElementById('playerCoins').textContent = playerData.coins || 0;

                // Carica l'inventario degli items
                const inventoryRef = ref(db, `players/${playerName}/inventory`);
                const inventorySnapshot = await get(inventoryRef);
                
                if (inventorySnapshot.exists()) {
                    playerInventory = inventorySnapshot.val();
                } else {
                    playerInventory = {
                        itempermanenti: {},
                        itemconsumabili: {},
                        mints: {},
                        mints_purchased: {}
                    };
                }

                return true;
            } catch (error) {
                console.error('Errore nel caricamento dei dati:', error);
                showError('Errore nel caricamento dei dati: ' + error.message);
                return false;
            }
        }

        function createItemCard(item, isPermanent = false) {
            const card = document.createElement('div');
            card.className = 'item-card';
            
            const price = PRICES[item.name] || 1000;
            let isSoldOut = false;
            let currentStock = null;

            // Controlla se √® gi√† stato acquistato (permanenti)
            if (isPermanent && playerInventory.itempermanenti && playerInventory.itempermanenti[item.name]) {
                isSoldOut = true;
            }

            // Controlla la disponibilit√† (mints) - usa mints_purchased per il limite di acquisto
            if (item.type === 'mint') {
                const totalPurchased = (playerInventory.mints_purchased && playerInventory.mints_purchased[item.name]) || 0;
                const currentOwned = (playerInventory.mints && playerInventory.mints[item.name]) || 0;
                currentStock = item.maxStock - totalPurchased;
                
                if (currentStock <= 0) {
                    isSoldOut = true;
                }
            }

            if (isSoldOut) {
                card.classList.add('sold-out');
            }

            card.innerHTML = `
                ${isSoldOut ? '<div class="sold-out-badge">ESAURITO</div>' : ''}
                <img src="${item.image}" alt="${item.name}" class="item-image" onerror="this.src='https://via.placeholder.com/100?text=Item'">
                <div class="item-name">${item.name}</div>
                <div class="item-description">${item.description}</div>
                ${item.type === 'mint' && !isSoldOut ? `<div class="item-stock">Disponibili: ${currentStock}/3</div>` : ''}
                <div class="item-price">
                    <img src="https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/pixel-art-red-chinese-gold-coin-png.png" 
                         alt="Coins" 
                         class="coin-img"
                         onerror="this.style.display='none'">
                    <span>${price}</span>
                </div>
                <button class="buy-btn" ${isSoldOut ? 'disabled' : ''} onclick="buyItem('${item.name}', ${price}, '${item.type}')">
                    ${isSoldOut ? 'ESAURITO' : 'üí∞ Acquista'}
                </button>
            `;

            return card;
        }

        function renderItems() {
            // Render permanent items
            const permanentGrid = document.getElementById('permanentItemsGrid');
            permanentGrid.innerHTML = '';
            permanentItems.forEach(item => {
                permanentGrid.appendChild(createItemCard(item, true));
            });

            // Render consumable items
            const consumableGrid = document.getElementById('consumableItemsGrid');
            consumableGrid.innerHTML = '';
            consumableItems.forEach(item => {
                consumableGrid.appendChild(createItemCard(item, false));
            });

            // Render mints
            const mintsGrid = document.getElementById('mintsGrid');
            mintsGrid.innerHTML = '';
            mints.forEach(item => {
                mintsGrid.appendChild(createItemCard(item, false));
            });
        }

        window.buyItem = async function(itemName, price, itemType) {
            if (!playerData) return;

            const currentCoins = playerData.coins || 0;

            if (currentCoins < price) {
                showError('Non hai abbastanza coins!');
                return;
            }

            try {
                const updates = {};
                
                // Aggiorna i coins
                updates[`players/${playerName}/coins`] = currentCoins - price;

                // Aggiorna l'inventario in base al tipo
                if (itemType === 'permanent') {
                    updates[`players/${playerName}/inventory/itempermanenti/${itemName}`] = true;
                } else if (itemType === 'mint') {
                    // Per le mints, aggiorna sia il possesso corrente che il contatore permanente
                    const currentOwned = (playerInventory.mints && playerInventory.mints[itemName]) || 0;
                    const totalPurchased = (playerInventory.mints_purchased && playerInventory.mints_purchased[itemName]) || 0;
                    
                    updates[`players/${playerName}/inventory/mints/${itemName}`] = currentOwned + 1;
                    updates[`players/${playerName}/inventory/mints_purchased/${itemName}`] = totalPurchased + 1;
                } else if (itemType === 'consumable') {
                    const currentCount = (playerInventory.itemconsumabili && playerInventory.itemconsumabili[itemName]) || 0;
                    updates[`players/${playerName}/inventory/itemconsumabili/${itemName}`] = currentCount + 1;
                }

                await update(ref(db), updates);

                showSuccess(`Hai acquistato ${itemName} per ${price} coins!`);
                
                // Ricarica i dati e aggiorna la visualizzazione
                await loadPlayerData();
                renderItems();

            } catch (error) {
                console.error('Errore nell\'acquisto:', error);
                showError('Errore nell\'acquisto: ' + error.message);
            }
        };

        function showError(message) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 5000);
        }

        function showSuccess(message) {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="success">${message}</div>`;
            setTimeout(() => {
                messageArea.innerHTML = '';
            }, 3000);
        }

        // Inizializzazione
        async function init() {
            const success = await loadPlayerData();
            if (success) {
                renderItems();
            }
        }

        init();
    </script>
</body>
</html>
