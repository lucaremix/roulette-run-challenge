<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallace - Sootopolis City</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/background/r-wallace_background.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #e0e0e0;
            text-decoration: none;
            font-size: 1em;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }

        .back-btn:hover {
            background: #252525;
        }

        .event-header {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .event-trainer-img {
            width: 160px;
            height: 160px;
            object-fit: contain;
            border: none;
            flex-shrink: 0;
            image-rendering: pixelated;
        }

        .event-info {
            flex: 1;
        }

        .event-title {
            font-size: 2.5em;
            color: #ffffff;
            margin-bottom: 15px;
        }

        .event-status {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }

        .status-badge {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1.1em;
        }

        .status-badge.joined {
            background: #2d4a2d;
            color: #7fff7f;
        }

        .status-badge.not-joined {
            background: #2a2a2a;
            color: #888;
        }

        .join-leave-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .join-btn {
            background: #2a7a2a;
            color: white;
        }

        .join-btn:hover {
            background: #357a35;
        }

        .leave-btn {
            background: #7a2a2a;
            color: white;
        }

        .leave-btn:hover {
            background: #8a3535;
        }

        .players-section {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .players-title {
            font-size: 1.8em;
            color: #ffffff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-count-badge {
            background: #2a2a2a;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.7em;
            color: #888;
        }

        .players-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-card {
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-card.current-user {
            border-color: #4a4a4a;
            background: #1f1f1f;
        }

        .player-name {
            font-size: 1.1em;
            color: #e0e0e0;
        }

        .player-card.current-user .player-name {
            color: #ffffff;
            font-weight: 600;
        }

        .you-badge {
            background: #2a7a2a;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .no-players {
            text-align: center;
            color: #555;
            font-style: italic;
            padding: 30px;
        }

        .intro-screen {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 40px;
            display: none;
        }

        .intro-screen.show {
            display: block;
        }

        .intro-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .intro-text h2 {
            font-size: 2em;
            color: #808080;
            margin-bottom: 20px;
            text-align: center;
        }

        .intro-text p {
            font-size: 1.2em;
            line-height: 1.8;
            color: #e0e0e0;
            margin-bottom: 15px;
        }

        .intro-text .highlight {
            color: #808080;
            font-weight: bold;
        }

        .start-btn {
            display: block;
            margin: 30px auto 0;
            padding: 20px 60px;
            background: #808080;
            color: #1a1a1a;
            border: none;
            border-radius: 8px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            background: #999999;
            transform: translateY(-2px);
        }

        .game-screen {
            display: none;
        }

        .game-screen.show {
            display: block;
        }

        .role-announcement {
            background: #1a1a1a;
            border: 2px solid #808080;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 30px;
            text-align: center;
        }

        .role-title {
            font-size: 2.5em;
            color: #808080;
            margin-bottom: 20px;
        }

        .role-description {
            font-size: 1.3em;
            color: #e0e0e0;
            line-height: 1.8;
        }

        .balls-preview {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 30px;
        }

        .preview-title {
            font-size: 2em;
            color: #808080;
            text-align: center;
            margin-bottom: 30px;
        }

        .balls-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .ball-preview {
            background: #0a0a0a;
            border: 2px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
        }

        .ball-image {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin-bottom: 20px;
        }

        .ball-label {
            font-size: 1.5em;
            color: #808080;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .pokemon-reveal {
            margin-top: 20px;
        }

        .pokemon-reveal img {
            width: 120px;
            height: 120px;
            object-fit: contain;
            margin: 10px auto;
        }

        .pokemon-reveal .pokemon-name {
            font-size: 1.3em;
            color: #ffffff;
            font-weight: 600;
        }

        .pokemon-reveal .pokemon-tier {
            font-size: 1em;
            color: #888;
            margin-top: 5px;
        }

        .balls-choice {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 30px;
        }

        .choice-title {
            font-size: 2em;
            color: #808080;
            text-align: center;
            margin-bottom: 30px;
        }

        .balls-selection {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        .ball-option {
            background: #0a0a0a;
            border: 2px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ball-option:hover {
            border-color: #808080;
            transform: translateY(-5px);
        }

        .ball-option.selected {
            border-color: #808080;
            background: rgba(128, 128, 128, 0.1);
        }

        .confirm-choice-btn {
            display: block;
            margin: 30px auto 0;
            padding: 15px 50px;
            background: #808080;
            color: #1a1a1a;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirm-choice-btn:hover:not(:disabled) {
            background: #999999;
        }

        .confirm-choice-btn:disabled {
            background: #2a2a2a;
            color: #555;
            cursor: not-allowed;
        }

        .waiting-screen {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 60px;
            text-align: center;
        }

        .waiting-text {
            font-size: 1.5em;
            color: #e0e0e0;
        }

        .results-screen {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 40px;
            display: none;
        }

        .results-screen.show {
            display: block;
        }

        .results-title {
            font-size: 2.5em;
            color: #808080;
            text-align: center;
            margin-bottom: 40px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 40px;
            max-width: 900px;
            margin: 0 auto 40px;
        }

        .player-result {
            background: #0a0a0a;
            border: 2px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
        }

        .player-result.current {
            border-color: #808080;
        }

        .result-player-name {
            font-size: 1.5em;
            color: #ffffff;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .result-ball-img {
            width: 100px;
            height: 100px;
            margin: 20px auto;
        }

        .result-pokemon-img {
            width: 150px;
            height: 150px;
            object-fit: contain;
            margin: 20px auto;
        }

        .result-pokemon-name {
            font-size: 1.8em;
            color: #808080;
            font-weight: bold;
            margin: 15px 0;
        }

        .result-tier {
            font-size: 1.2em;
            color: #888;
        }

        .continue-btn {
            display: block;
            margin: 0 auto;
            padding: 15px 50px;
            background: #808080;
            color: #1a1a1a;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .continue-btn:hover {
            background: #999999;
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .event-header {
                flex-direction: column;
                text-align: center;
            }

            .balls-grid,
            .balls-selection,
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">← Torna alla Home</a>

        <!-- Landing / Join Section -->
        <div id="landingSection">
            <div class="event-header">
                <img src="https://img.nuzlocke.app/leaders/rs-wallace-oras.png" 
                     alt="Drayden" class="event-trainer-img">
                <div class="event-info">
                    <h1 class="event-title">Wallace - Sootopolis City</h1>
                    <p style="font-size: 1.1em; color: #ccc;">
                        Un giocatore vede il contenuto di due ball e l'altro deve sceglierne una alla cieca!
                        Una contiene un Pokémon Pool A, l'altra un Pokémon Legendary!
                    </p>
                    <div class="event-status">
                        <span class="status-badge not-joined" id="joinStatus">Non partecipante</span>
                        <button class="join-leave-btn join-btn" id="joinBtn" onclick="toggleJoin()">
                            Unisciti all'evento
                        </button>
                    </div>
                </div>
            </div>

            <div class="players-section">
                <div class="players-title">
                    Giocatori
                    <span class="player-count-badge" id="playerCount">0/2</span>
                </div>
                <div class="players-list" id="playersList">
                    <div class="no-players">Nessun giocatore nell'evento</div>
                </div>
            </div>
        </div>

        <!-- Intro Screen -->
        <div class="intro-screen" id="introScreen">
            <div class="intro-content">
                <div class="intro-text">
                    <h2>⚔️ Ball Choice Challenge ⚔️</h2>
                    <p>Benvenuti alla sfida di Drayden!</p>
                    <p>
                        <span class="highlight">Come funziona:</span><br>
                        • Un giocatore casuale viene scelto come <span class="highlight">Osservatore</span><br>
                        • L'Osservatore vede il contenuto di due ball:<br>
                        &nbsp;&nbsp;&nbsp;- Una <span class="highlight">Poké Ball</span> con un Pokémon Pool A<br>
                        &nbsp;&nbsp;&nbsp;- Una <span class="highlight">Premier Ball</span> con un Pokémon Legendary<br>
                        • L'altro giocatore deve <span class="highlight">scegliere una ball alla cieca</span><br>
                        • Ogni giocatore riceve il Pokémon nella ball che gli spetta
                    </p>
                    <p>
                        <span class="highlight">Ricompense:</span><br>
                        💰 Entrambi i giocatori: 1500 Coins
                    </p>
                    <p style="color: #888; font-size: 1em; margin-top: 20px;">
                        Nota: I Pokémon verranno rimossi dai rispettivi pool
                    </p>
                </div>
                <button class="start-btn" onclick="startChallenge()">Inizia la Sfida</button>
            </div>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <!-- Role Announcement -->
            <div class="role-announcement" id="roleAnnouncement">
                <h2 class="role-title" id="roleTitle">Il tuo ruolo...</h2>
                <p class="role-description" id="roleDescription"></p>
            </div>

            <!-- Observer View - Balls Preview -->
            <div class="balls-preview" id="ballsPreview" style="display: none;">
                <h3 class="preview-title">🔍 Contenuto delle Ball 🔍</h3>
                <div class="balls-grid">
                    <div class="ball-preview">
                        <img src="https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/images/pokeball.png" 
                             alt="Poké Ball" class="ball-image">
                        <div class="ball-label">Poké Ball</div>
                        <div class="pokemon-reveal" id="pokeballContent">
                            <!-- Pokemon A will be shown here -->
                        </div>
                    </div>
                    <div class="ball-preview">
                        <img src="https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/images/premierball.png" 
                             alt="Premier Ball" class="ball-image">
                        <div class="ball-label">Premier Ball</div>
                        <div class="pokemon-reveal" id="premierballContent">
                            <!-- Pokemon Legendary will be shown here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chooser View - Ball Selection -->
            <div class="balls-choice" id="ballsChoice" style="display: none;">
                <h3 class="choice-title">Scegli una Ball!</h3>
                <div class="balls-selection">
                    <div class="ball-option" data-ball="pokeball" onclick="selectBall('pokeball')">
                        <img src="https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/images/pokeball.png" 
                             alt="Poké Ball" class="ball-image">
                        <div class="ball-label">Poké Ball</div>
                    </div>
                    <div class="ball-option" data-ball="premierball" onclick="selectBall('premierball')">
                        <img src="https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/images/premierball.png" 
                             alt="Premier Ball" class="ball-image">
                        <div class="ball-label">Premier Ball</div>
                    </div>
                </div>
                <button class="confirm-choice-btn" id="confirmChoiceBtn" onclick="confirmChoice()" disabled>
                    Conferma Scelta
                </button>
            </div>

            <!-- Waiting Screen -->
            <div class="waiting-screen" id="waitingScreen" style="display: none;">
                <p class="waiting-text" id="waitingText">In attesa...</p>
            </div>
        </div>

        <!-- Results Screen -->
        <div class="results-screen" id="resultsScreen">
            <h2 class="results-title">🎉 Risultati 🎉</h2>
            <div class="results-grid" id="resultsGrid">
                <!-- Results will be shown here -->
            </div>
            <button class="continue-btn" onclick="goHome()">Torna alla Home</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, set, get, remove, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDNuD9wViLLxteHMCEBlvfdONwcZbAjAvo",
            authDomain: "roulette-run-challenge.firebaseapp.com",
            databaseURL: "https://roulette-run-challenge-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "roulette-run-challenge",
            storageBucket: "roulette-run-challenge.firebasestorage.app",
            messagingSenderId: "994019156093",
            appId: "1:994019156093:web:9792bdce75c486f589d114"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const eventRef = ref(database, 'events/drayden');

        let gameState = null;
        let selectedBall = null;
        const MAX_PLAYERS = 2;

        const natures = [
            "Hardy", "Lonely", "Brave", "Adamant", "Naughty",
            "Bold", "Docile", "Relaxed", "Impish", "Lax",
            "Timid", "Hasty", "Serious", "Jolly", "Naive",
            "Modest", "Mild", "Quiet", "Bashful", "Rash",
            "Calm", "Gentle", "Sassy", "Careful", "Quirky"
        ];

        function getCurrentPlayer() {
            return localStorage.getItem('playerName') || '';
        }

        function padNumber(num) {
            return String(num).padStart(3, '0');
        }

        function renderLanding() {
            const currentPlayer = getCurrentPlayer();
            const playersRef = ref(database, `events/drayden/players`);

            onValue(playersRef, (snapshot) => {
                const players = [];
                snapshot.forEach((childSnapshot) => {
                    players.push(childSnapshot.val());
                });

                const isJoined = players.includes(currentPlayer);

                const statusBadge = document.getElementById('joinStatus');
                const joinLeaveBtn = document.getElementById('joinBtn');

                if (statusBadge && joinLeaveBtn) {
                    if (isJoined) {
                        statusBadge.textContent = 'Partecipante';
                        statusBadge.className = 'status-badge joined';
                        joinLeaveBtn.textContent = 'Abbandona evento';
                        joinLeaveBtn.className = 'join-leave-btn leave-btn';
                    } else {
                        statusBadge.textContent = 'Non partecipante';
                        statusBadge.className = 'status-badge not-joined';
                        joinLeaveBtn.textContent = 'Unisciti all\'evento';
                        joinLeaveBtn.className = 'join-leave-btn join-btn';
                    }
                }

                const countBadge = document.getElementById('playerCount');
                if (countBadge) {
                    countBadge.textContent = `${players.length}/2`;
                }

                const playersList = document.getElementById('playersList');
                
                if (playersList) {
                    if (players.length === 0) {
                        playersList.innerHTML = '<div class="no-players">Nessun giocatore nell\'evento</div>';
                    } else {
                        playersList.innerHTML = players.map(player => {
                            const isCurrentUser = player === currentPlayer;
                            return `
                                <div class="player-card ${isCurrentUser ? 'current-user' : ''}">
                                    <span class="player-name">${player}</span>
                                    ${isCurrentUser ? '<span class="you-badge">Tu</span>' : ''}
                                </div>
                            `;
                        }).join('');
                    }
                }

                if (players.length === 2 && players.includes(currentPlayer)) {
                    document.getElementById('landingSection').style.display = 'none';
                    document.getElementById('introScreen').classList.add('show');
                } else {
                    document.getElementById('landingSection').style.display = 'block';
                    document.getElementById('introScreen').classList.remove('show');
                }
            });

            onValue(eventRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                gameState = data;

                if (data.gameStarted && !data.gameCompleted) {
                    document.getElementById('landingSection').style.display = 'none';
                    document.getElementById('introScreen').classList.remove('show');
                    document.getElementById('gameScreen').classList.add('show');
                    renderGame();
                }

                if (data.gameCompleted) {
                    showResults(data);
                }
            });
        }

        async function toggleJoin() {
            const playerName = getCurrentPlayer();
            if (!playerName) {
                alert('Devi impostare il tuo nome dalla home page!');
                window.location.href = 'index.html';
                return;
            }

            const playersRef = ref(database, `events/drayden/players`);
            
            const snapshot = await new Promise((resolve) => {
                onValue(playersRef, (snap) => resolve(snap), { onlyOnce: true });
            });

            let isInEvent = false;
            let playerNodeKey = null;

            snapshot.forEach((childSnapshot) => {
                if (childSnapshot.val() === playerName) {
                    isInEvent = true;
                    playerNodeKey = childSnapshot.key;
                }
            });

            if (isInEvent && playerNodeKey) {
                await remove(ref(database, `events/drayden/players/${playerNodeKey}`));
            } else {
                const newPlayerRef = push(ref(database, `events/drayden/players`));
                await set(newPlayerRef, playerName);
            }
        }

        window.toggleJoin = toggleJoin;

        window.startChallenge = async function() {
            const playersRef = ref(database, `events/drayden/players`);
            const snapshot = await get(playersRef);
            
            const players = [];
            snapshot.forEach((childSnapshot) => {
                players.push(childSnapshot.val());
            });

            if (players.length !== 2) {
                alert('Servono esattamente 2 giocatori per iniziare!');
                return;
            }

            // Random observer
            const observerIndex = Math.floor(Math.random() * 2);
            const observer = players[observerIndex];
            const chooser = players[1 - observerIndex];

            // Get random pokemon from pools
            const aTierRef = ref(database, 'pools/a_tier');
            const legendaryRef = ref(database, 'pools/legendary');

            const aTierSnap = await get(aTierRef);
            const legendarySnap = await get(legendaryRef);

            const aTierPokemon = [];
            const legendaryPokemon = [];

            aTierSnap.forEach(child => {
                aTierPokemon.push({ key: child.key, ...child.val() });
            });

            legendarySnap.forEach(child => {
                legendaryPokemon.push({ key: child.key, ...child.val() });
            });

            if (aTierPokemon.length === 0 || legendaryPokemon.length === 0) {
                alert('Non ci sono abbastanza Pokémon nei pool!');
                return;
            }

            const randomATier = aTierPokemon[Math.floor(Math.random() * aTierPokemon.length)];
            const randomLegendary = legendaryPokemon[Math.floor(Math.random() * legendaryPokemon.length)];

            // Genera natura casuale per entrambi i Pokémon
            const aTierNature = natures[Math.floor(Math.random() * natures.length)];
            const legendaryNature = natures[Math.floor(Math.random() * natures.length)];

            // Scegli abilità casuale per A Tier (non hidden)
            const aTierAbilities = [
                randomATier.abilities_0,
                randomATier.abilities_1,
                randomATier.abilities_2
            ].filter(a => a && a.trim() !== '');
            const aTierAbility = aTierAbilities.length > 0 
                ? aTierAbilities[Math.floor(Math.random() * aTierAbilities.length)]
                : 'Unknown';

            // Scegli abilità casuale per Legendary (non hidden)
            const legendaryAbilities = [
                randomLegendary.abilities_0,
                randomLegendary.abilities_1,
                randomLegendary.abilities_2
            ].filter(a => a && a.trim() !== '');
            const legendaryAbility = legendaryAbilities.length > 0 
                ? legendaryAbilities[Math.floor(Math.random() * legendaryAbilities.length)]
                : 'Unknown';

            const gameData = {
                gameStarted: true,
                observer: observer,
                chooser: chooser,
                pokeball: {
                    pokemon: {
                        ...randomATier,
                        rolled_nature: aTierNature,
                        rolled_ability: aTierAbility
                    },
                    tier: 'Pool A'
                },
                premierball: {
                    pokemon: {
                        ...randomLegendary,
                        rolled_nature: legendaryNature,
                        rolled_ability: legendaryAbility
                    },
                    tier: 'Pool Legendary'
                },
                choice: null,
                gameCompleted: false
            };

            await set(eventRef, gameData);
        };

        function renderGame() {
            if (!gameState) return;

            const currentPlayer = getCurrentPlayer();
            const isObserver = currentPlayer === gameState.observer;

            document.getElementById('roleAnnouncement').style.display = 'block';

            if (isObserver) {
                document.getElementById('roleTitle').textContent = '👁️ Sei l\'Osservatore 👁️';
                document.getElementById('roleDescription').textContent = 
                    'Puoi vedere il contenuto delle due ball. Aspetta che l\'altro giocatore faccia la sua scelta!';
                
                setTimeout(() => {
                    document.getElementById('roleAnnouncement').style.display = 'none';
                    document.getElementById('ballsPreview').style.display = 'block';
                    document.getElementById('waitingScreen').style.display = 'block';
                    document.getElementById('waitingText').textContent = 'In attesa della scelta dell\'altro giocatore...';
                    
                    renderBallsPreview();
                }, 3000);
            } else {
                document.getElementById('roleTitle').textContent = '🎯 Sei il Giocatore 🎯';
                document.getElementById('roleDescription').textContent = 
                    'Devi scegliere una ball senza sapere cosa contiene. Scegli con saggezza!';
                
                setTimeout(() => {
                    document.getElementById('roleAnnouncement').style.display = 'none';
                    
                    if (gameState.choice) {
                        document.getElementById('waitingScreen').style.display = 'block';
                        document.getElementById('waitingText').textContent = 'Scelta confermata! In attesa dei risultati...';
                    } else {
                        document.getElementById('ballsChoice').style.display = 'block';
                    }
                }, 3000);
            }
        }

        function renderBallsPreview() {
            const pokeballPokemon = gameState.pokeball.pokemon;
            const premierballPokemon = gameState.premierball.pokemon;

            const pokeballName = pokeballPokemon.name || pokeballPokemon.english_name || 'Unknown';
            const premierballName = premierballPokemon.name || premierballPokemon.english_name || 'Unknown';

            document.getElementById('pokeballContent').innerHTML = `
                <img src="https://www.pokemon.com/static-assets/content-assets/cms2/img/pokedex/full/${padNumber(pokeballPokemon.national_number)}.png" 
                     alt="${pokeballName}">
                <div class="pokemon-name">${pokeballName}</div>
                <div class="pokemon-tier">Pool A</div>
                <div class="pokemon-tier" style="font-size: 0.9em; margin-top: 5px;">Natura: ${pokeballPokemon.rolled_nature}</div>
                <div class="pokemon-tier" style="font-size: 0.9em;">Abilità: ${pokeballPokemon.rolled_ability}</div>
            `;

            document.getElementById('premierballContent').innerHTML = `
                <img src="https://www.pokemon.com/static-assets/content-assets/cms2/img/pokedex/full/${padNumber(premierballPokemon.national_number)}.png" 
                     alt="${premierballName}">
                <div class="pokemon-name">${premierballName}</div>
                <div class="pokemon-tier">Pool Legendary</div>
                <div class="pokemon-tier" style="font-size: 0.9em; margin-top: 5px;">Natura: ${premierballPokemon.rolled_nature}</div>
                <div class="pokemon-tier" style="font-size: 0.9em;">Abilità: ${premierballPokemon.rolled_ability}</div>
            `;
        }

        window.selectBall = function(ball) {
            selectedBall = ball;
            
            document.querySelectorAll('.ball-option').forEach(el => {
                el.classList.remove('selected');
            });
            
            document.querySelector(`[data-ball="${ball}"]`).classList.add('selected');
            document.getElementById('confirmChoiceBtn').disabled = false;
        };

        window.confirmChoice = async function() {
            if (!selectedBall) return;

            const snapshot = await get(eventRef);
            const data = snapshot.val();

            data.choice = selectedBall;
            await set(eventRef, data);

            document.getElementById('ballsChoice').style.display = 'none';
            document.getElementById('waitingScreen').style.display = 'block';
            document.getElementById('waitingText').textContent = 'Scelta confermata! In attesa dei risultati...';

            await processResults(data);
        };

        async function processResults(data) {
            const chooserBall = data.choice;
            const observerBall = chooserBall === 'pokeball' ? 'premierball' : 'pokeball';

            const chooserPokemon = data[chooserBall].pokemon;
            const observerPokemon = data[observerBall].pokemon;

            console.log('Chooser Pokemon:', chooserPokemon);
            console.log('Observer Pokemon:', observerPokemon);

            // Prepare pokemon data (remove key field and add won_from/won_at)
            const chooserPokemonData = {
                ...chooserPokemon,
                nature: chooserPokemon.rolled_nature,
                ability: chooserPokemon.rolled_ability,
                won_from: data[chooserBall].tier === 'Pool A' ? 'a_tier' : 'legendary',
                won_at: Date.now()
            };
            delete chooserPokemonData.key;
            delete chooserPokemonData.rolled_nature;
            delete chooserPokemonData.rolled_ability;
            
            const observerPokemonData = {
                ...observerPokemon,
                nature: observerPokemon.rolled_nature,
                ability: observerPokemon.rolled_ability,
                won_from: data[observerBall].tier === 'Pool A' ? 'a_tier' : 'legendary',
                won_at: Date.now()
            };
            delete observerPokemonData.key;
            delete observerPokemonData.rolled_nature;
            delete observerPokemonData.rolled_ability;

            // Add pokemon to teams with sequential numbers
            // Get current team size for chooser
            const chooserTeamSnapshot = await get(ref(database, `players/${data.chooser}/rubyteam`));
            let chooserTeamSize = 0;
            chooserTeamSnapshot.forEach(() => chooserTeamSize++);
            
            // Get current team size for observer
            const observerTeamSnapshot = await get(ref(database, `players/${data.observer}/rubyteam`));
            let observerTeamSize = 0;
            observerTeamSnapshot.forEach(() => observerTeamSize++);
            
            // Add pokemon with sequential numbers
            await set(ref(database, `players/${data.chooser}/rubyteam/${chooserTeamSize}`), chooserPokemonData);
            await set(ref(database, `players/${data.observer}/rubyteam/${observerTeamSize}`), observerPokemonData);
            
            console.log('Pokemon added to teams');

            // Add coins to both players
            const chooserRef = ref(database, `players/${data.chooser}/coins`);
            const observerRef = ref(database, `players/${data.observer}/coins`);

            const chooserCoinsSnap = await get(chooserRef);
            const observerCoinsSnap = await get(observerRef);

            const chooserCoins = (chooserCoinsSnap.val() || 0) + 1500;
            const observerCoins = (observerCoinsSnap.val() || 0) + 1500;

            await set(chooserRef, chooserCoins);
            await set(observerRef, observerCoins);

            console.log('Coins added to players');

            // Remove pokemon from pools
            const chooserTier = data[chooserBall].tier === 'Pool A' ? 'a_tier' : 'legendary';
            const observerTier = data[observerBall].tier === 'Pool A' ? 'a_tier' : 'legendary';

            await remove(ref(database, `pools/${chooserTier}/${chooserPokemon.key}`));
            await remove(ref(database, `pools/${observerTier}/${observerPokemon.key}`));

            console.log('Pokemon removed from pools');

            data.gameCompleted = true;
            data.results = {
                chooser: {
                    player: data.chooser,
                    ball: chooserBall,
                    pokemon: chooserPokemon,
                    tier: data[chooserBall].tier
                },
                observer: {
                    player: data.observer,
                    ball: observerBall,
                    pokemon: observerPokemon,
                    tier: data[observerBall].tier
                }
            };

            await set(eventRef, data);
        }

        function showResults(data) {
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('resultsScreen').classList.add('show');

            const currentPlayer = getCurrentPlayer();
            const resultsGrid = document.getElementById('resultsGrid');

            const chooserResult = data.results.chooser;
            const observerResult = data.results.observer;

            const chooserName = chooserResult.pokemon.name || chooserResult.pokemon.english_name || 'Unknown';
            const observerName = observerResult.pokemon.name || observerResult.pokemon.english_name || 'Unknown';

            resultsGrid.innerHTML = `
                <div class="player-result ${chooserResult.player === currentPlayer ? 'current' : ''}">
                    <div class="result-player-name">${chooserResult.player}</div>
                    <div class="result-ball-img">
                        <img src="https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/images/${chooserResult.ball}.png" 
                             alt="${chooserResult.ball}" style="width: 100%; height: 100%;">
                    </div>
                    <div class="result-pokemon-img">
                        <img src="https://www.pokemon.com/static-assets/content-assets/cms2/img/pokedex/full/${padNumber(chooserResult.pokemon.national_number)}.png" 
                             alt="${chooserName}" style="width: 100%; height: 100%;">
                    </div>
                    <div class="result-pokemon-name">${chooserName}</div>
                    <div class="result-tier">${chooserResult.tier}</div>
                    <div class="result-tier" style="font-size: 0.9em; margin-top: 5px;">Natura: ${chooserResult.pokemon.rolled_nature}</div>
                    <div class="result-tier" style="font-size: 0.9em;">Abilità: ${chooserResult.pokemon.rolled_ability}</div>
                    <div class="result-tier" style="margin-top: 10px;">+150 Coins</div>
                </div>
                <div class="player-result ${observerResult.player === currentPlayer ? 'current' : ''}">
                    <div class="result-player-name">${observerResult.player}</div>
                    <div class="result-ball-img">
                        <img src="https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/images/${observerResult.ball}.png" 
                             alt="${observerResult.ball}" style="width: 100%; height: 100%;">
                    </div>
                    <div class="result-pokemon-img">
                        <img src="https://www.pokemon.com/static-assets/content-assets/cms2/img/pokedex/full/${padNumber(observerResult.pokemon.national_number)}.png" 
                             alt="${observerName}" style="width: 100%; height: 100%;">
                    </div>
                    <div class="result-pokemon-name">${observerName}</div>
                    <div class="result-tier">${observerResult.tier}</div>
                    <div class="result-tier" style="font-size: 0.9em; margin-top: 5px;">Natura: ${observerResult.pokemon.rolled_nature}</div>
                    <div class="result-tier" style="font-size: 0.9em;">Abilità: ${observerResult.pokemon.rolled_ability}</div>
                    <div class="result-tier" style="margin-top: 10px;">+150 Coins</div>
                </div>
            `;
        }

        window.goHome = function() {
            window.location.href = 'index.html';
        };

        if (!getCurrentPlayer()) {
            alert('Devi impostare il tuo nome dalla home page!');
            window.location.href = 'index.html';
        } else {
            renderLanding();
        }
    </script>
</body>
</html>
