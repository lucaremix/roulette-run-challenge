<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Spin - Roulette Run Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('https://raw.githubusercontent.com/lucaremix/roulette-run-challenge/main/background/rubyspin_background.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #e0e0e0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
        }

        h1 {
            font-size: 2.5em;
            color: #fff;
            margin-bottom: 10px;
        }

        .back-btn {
            display: inline-block;
            padding: 10px 20px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #e0e0e0;
            text-decoration: none;
            margin-bottom: 20px;
        }

        /* ITEMS BOX */
        .items-box {
            background: #1a1a1a;
            border: 2px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .items-title {
            font-size: 1.3em;
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .item-card {
            background: #0a0a0a;
            border: 2px solid #2a2a2a;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .item-card:hover:not(.disabled) {
            border-color: #ffd700;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .item-card.active {
            border-color: #2a7a2a;
            background: #1a3a1a;
            box-shadow: 0 0 20px rgba(42, 122, 42, 0.5);
        }

        .item-card.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .item-image {
            width: 60px;
            height: 60px;
            object-fit: contain;
            margin-bottom: 10px;
            image-rendering: auto;
        }

        .item-name {
            font-size: 0.9em;
            color: #fff;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .item-quantity {
            font-size: 0.8em;
            color: #ffd700;
        }

        .item-effect {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #2a7a2a;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: bold;
        }

        /* TIER SELECTOR */
        .tier-selector {
            background: #1a1a1a;
            border: 2px solid #2a2a2a;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .tier-title {
            font-size: 1.3em;
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }

        .tier-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tier-btn {
            width: 80px;
            height: 80px;
            background: #0a0a0a;
            border: 3px solid #2a2a2a;
            border-radius: 12px;
            color: #fff;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tier-btn:hover {
            border-color: #ffd700;
            transform: scale(1.1);
        }

        .tier-btn.selected {
            border-color: #2a7a2a;
            background: #1a3a1a;
            box-shadow: 0 0 20px rgba(42, 122, 42, 0.5);
        }

        .tier-btn.tier-c { color: #8b8b8b; }
        .tier-btn.tier-b { color: #4a90e2; }
        .tier-btn.tier-a { color: #9b59b6; }
        .tier-btn.tier-s { color: #f39c12; }
        .tier-btn.tier-l { color: #e74c3c; }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
            background: #1a1a1a;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #2a2a2a;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-group label {
            font-size: 0.9em;
            color: #888;
        }

        select, input {
            padding: 12px 20px;
            background: #0a0a0a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1em;
        }

        .player-info {
            text-align: center;
            font-size: 1.2em;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .spin-btn {
            padding: 15px 40px;
            background: #2a7a2a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .spin-btn:hover:not(:disabled) {
            background: #357a35;
            transform: scale(1.05);
        }

        .spin-btn:disabled {
            background: #2a2a2a;
            cursor: not-allowed;
            opacity: 0.5;
        }

        .slot-machine {
            position: relative;
            margin: 40px auto;
            width: 100%;
            max-width: 800px;
            height: 200px;
            background: #1a1a1a;
            border: 3px solid #2a2a2a;
            border-radius: 12px;
            overflow: hidden;
        }

        .slot-window {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 180px;
            height: 180px;
            border: 4px solid #ffd700;
            border-radius: 12px;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .slot-reel {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }

        .pokemon-slot {
            position: relative;
            width: 150px;
            height: 150px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0a0a;
            border-radius: 8px;
        }

        .pokemon-slot img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: auto;
        }

        .shiny-badge {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 1.5em;
            z-index: 5;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }

        .result-panel {
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            margin-top: 30px;
            text-align: center;
            display: none;
        }

        .result-panel.show {
            display: block;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-pokemon {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .result-pokemon-image {
            position: relative;
            width: 200px;
            height: 200px;
        }

        .result-pokemon-image img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .result-shiny-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 2em;
            z-index: 5;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.9);
        }

        .result-info {
            text-align: left;
        }

        .result-info h2 {
            font-size: 2em;
            color: #ffd700;
            margin-bottom: 15px;
        }

        .result-stat {
            margin: 10px 0;
            font-size: 1.1em;
        }

        .result-stat strong {
            color: #888;
            margin-right: 10px;
        }

        .shiny-text {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2em;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .add-btn {
            padding: 15px 40px;
            background: #2a7a2a;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .add-btn:hover {
            background: #357a35;
            transform: scale(1.05);
        }

        /* Type Selector Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1a1a;
            border: 2px solid #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
        }

        .modal-title {
            font-size: 1.5em;
            color: #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }

        .type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .type-btn {
            padding: 10px;
            background: #0a0a0a;
            border: 2px solid #2a2a2a;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-weight: bold;
        }

        .type-btn:hover {
            border-color: #ffd700;
            transform: scale(1.05);
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn.confirm {
            background: #2a7a2a;
            color: white;
        }

        .modal-btn.cancel {
            background: #c41e3a;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-btn">← Torna alla Home</a>
        
        <header>
            <h1>🎰 Pokemon Spin</h1>
            <div class="player-info">
                👤 Player: <span id="playerName">Loading...</span>
            </div>
        </header>

        <!-- ITEMS BOX -->
        <div class="items-box">
            <div class="items-title">🎁 Items Attivi</div>
            <div class="items-grid" id="itemsGrid">
                <div class="loading">Caricamento items...</div>
            </div>
        </div>

        <!-- TIER SELECTOR -->
        <div class="tier-selector">
            <div class="tier-title">⭐ Seleziona Tier</div>
            <div class="tier-buttons">
                <button class="tier-btn tier-c" data-tier="C" onclick="selectTier('C')">C</button>
                <button class="tier-btn tier-b" data-tier="B" onclick="selectTier('B')">B</button>
                <button class="tier-btn tier-a" data-tier="A" onclick="selectTier('A')">A</button>
                <button class="tier-btn tier-s" data-tier="S" onclick="selectTier('S')">S</button>
                <button class="tier-btn tier-l" data-tier="L" onclick="selectTier('L')">L</button>
            </div>
        </div>

        <div class="controls">
            <button id="spinBtn" class="spin-btn" onclick="startSpin()">🎲 SPIN!</button>
        </div>

        <div class="slot-machine">
            <div class="slot-window"></div>
            <div id="slotReel" class="slot-reel"></div>
        </div>

        <div id="resultPanel" class="result-panel">
            <h2>🎉 Hai vinto!</h2>
            <div id="resultPokemon" class="result-pokemon"></div>
            <button class="add-btn" onclick="addToTeam()">➕ Aggiungi al Ruby Team</button>
        </div>
    </div>

    <!-- Type Selector Modal -->
    <div id="typeModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Seleziona Tipo da Evitare</div>
            <div class="type-grid" id="typeGrid"></div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeTypeModal()">Annulla</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getDatabase, ref, get, set, update, remove, onValue } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBQpow283Yne3xY88NZHRFәlk9TElI8Ey0",
            authDomain: "roulette-run-challenge.firebaseapp.com",
            databaseURL: "https://roulette-run-challenge-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "roulette-run-challenge",
            storageBucket: "roulette-run-challenge.firebasestorage.app",
            messagingSenderId: "155292105112",
            appId: "1:155292105112:web:b00b86bc4ee2fd46f9d8b6"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let playerName = localStorage.getItem('playerName');
        let playerInventory = null;
        let currentPool = [];
        let selectedTier = 'C';
        let shinyPokemonCount = 1; // Default
        let wonPokemon = null;
        let wonPokemonKey = null;
        let isSpinning = false;

        // Active items state
        let activeItems = {
            shinyCharm: false,
            spinEnhancer: false,
            typeAvoider: null // Will store the type to avoid
        };

        const natures = [
            "Hardy", "Lonely", "Brave", "Adamant", "Naughty",
            "Bold", "Docile", "Relaxed", "Impish", "Lax",
            "Timid", "Hasty", "Serious", "Jolly", "Naive",
            "Modest", "Mild", "Quiet", "Bashful", "Rash",
            "Calm", "Gentle", "Sassy", "Careful", "Quirky"
        ];

        const pokemonTypes = [
            "Normal", "Fire", "Water", "Electric", "Grass", "Ice",
            "Fighting", "Poison", "Ground", "Flying", "Psychic", "Bug",
            "Rock", "Ghost", "Dragon", "Dark", "Steel", "Fairy"
        ];

        function padNumber(num) {
            return String(num).padStart(3, '0');
        }

        function getPokemonImageUrl(nationalNumber) {
            return `https://www.pokemon.com/static-assets/content-assets/cms2/img/pokedex/full/${padNumber(nationalNumber)}.png`;
        }

        async function init() {
            if (!playerName) {
                alert('Nessun giocatore selezionato! Torna alla home.');
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('playerName').textContent = playerName;
            await loadPlayerInventory();
            renderItems();
            selectTier('C'); // Seleziona C di default
        }

        async function loadPlayerInventory() {
            try {
                const inventoryRef = ref(database, `players/${playerName}/inventory`);
                const snapshot = await get(inventoryRef);
                
                if (snapshot.exists()) {
                    playerInventory = snapshot.val();
                } else {
                    playerInventory = {
                        itempermanenti: {},
                        itemconsumabili: {}
                    };
                }
            } catch (error) {
                console.error('Errore caricamento inventario:', error);
                playerInventory = { itempermanenti: {}, itemconsumabili: {} };
            }
        }

        function renderItems() {
            const itemsGrid = document.getElementById('itemsGrid');
            const items = [];

            // Shiny Charm (Permanent)
            if (playerInventory.itempermanenti && playerInventory.itempermanenti['Shiny Charm']) {
                items.push({
                    name: 'Shiny Charm',
                    image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-shinycharm.png?raw=true',
                    quantity: null,
                    effect: '3 Shiny',
                    consumable: false,
                    key: 'shinyCharm'
                });
            }

            // Spin Enhancer Cell (Consumable)
            const spinEnhancerCount = (playerInventory.itemconsumabili && playerInventory.itemconsumabili['Spin Enhancer Cell']) || 0;
            if (spinEnhancerCount > 0) {
                items.push({
                    name: 'Spin Enhancer Cell',
                    image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-spinenhancercell.png?raw=true',
                    quantity: spinEnhancerCount,
                    effect: 'Tier +1',
                    consumable: true,
                    key: 'spinEnhancer'
                });
            }

            // Type Avoider Herb (Consumable)
            const typeAvoiderCount = (playerInventory.itemconsumabili && playerInventory.itemconsumabili['Type Avoider Herb']) || 0;
            if (typeAvoiderCount > 0) {
                items.push({
                    name: 'Type Avoider Herb',
                    image: 'https://github.com/lucaremix/roulette-run-challenge/blob/main/images/items/item-typeavoiderherb.png?raw=true',
                    quantity: typeAvoiderCount,
                    effect: 'Skip Type',
                    consumable: true,
                    key: 'typeAvoider'
                });
            }

            if (items.length === 0) {
                itemsGrid.innerHTML = '<div class="loading">Nessun item disponibile</div>';
                return;
            }

            itemsGrid.innerHTML = items.map(item => `
                <div class="item-card ${activeItems[item.key] ? 'active' : ''}" 
                     onclick="toggleItem('${item.key}', ${item.consumable})">
                    ${activeItems[item.key] ? '<div class="item-effect">ATTIVO</div>' : ''}
                    <img src="${item.image}" alt="${item.name}" class="item-image" 
                         onerror="this.src='https://via.placeholder.com/60?text=Item'">
                    <div class="item-name">${item.name}</div>
                    ${item.quantity !== null ? `<div class="item-quantity">x${item.quantity}</div>` : ''}
                </div>
            `).join('');
        }

        window.toggleItem = async function(itemKey, consumable) {
            if (itemKey === 'typeAvoider') {
                // Mostra modal per selezione tipo
                openTypeModal();
                return;
            }

            // Toggle item
            activeItems[itemKey] = !activeItems[itemKey];

            if (activeItems[itemKey]) {
                // Applica effetto
                if (itemKey === 'shinyCharm') {
                    shinyPokemonCount = 3;
                } else if (itemKey === 'spinEnhancer') {
                    enhanceTier();
                }
            } else {
                // Rimuovi effetto
                if (itemKey === 'shinyCharm') {
                    shinyPokemonCount = 1;
                } else if (itemKey === 'spinEnhancer') {
                    // Reset tier enhancement
                    selectTier(selectedTier);
                }
            }

            renderItems();
        };

        function enhanceTier() {
            const tierMap = { 'C': 'B', 'B': 'A', 'A': 'S', 'S': 'S', 'L': 'L' };
            const enhancedTier = tierMap[selectedTier];
            
            // Aggiorna visualmente il tier selezionato
            document.querySelectorAll('.tier-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.tier === enhancedTier) {
                    btn.classList.add('selected');
                }
            });
        }

        window.selectTier = function(tier) {
            selectedTier = tier;
            
            document.querySelectorAll('.tier-btn').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.tier === tier) {
                    btn.classList.add('selected');
                }
            });

            // Ricarica il pool con il tier selezionato
            loadPool();
        };

        function openTypeModal() {
            const modal = document.getElementById('typeModal');
            const typeGrid = document.getElementById('typeGrid');
            
            typeGrid.innerHTML = pokemonTypes.map(type => `
                <div class="type-btn" onclick="selectType('${type}')">${type}</div>
            `).join('');
            
            modal.classList.add('show');
        }

        window.closeTypeModal = function() {
            document.getElementById('typeModal').classList.remove('show');
        };

        window.selectType = async function(type) {
            activeItems.typeAvoider = type;
            closeTypeModal();
            
            // Consuma l'item
            const currentCount = playerInventory.itemconsumabili['Type Avoider Herb'] || 0;
            if (currentCount > 0) {
                await update(ref(database), {
                    [`players/${playerName}/inventory/itemconsumabili/Type Avoider Herb`]: currentCount - 1
                });
                await loadPlayerInventory();
            }
            
            renderItems();
            alert(`Type Avoider attivato! Verrà evitato il tipo ${type}`);
        };

        function loadPool() {
            let tierToLoad = selectedTier;
            
            // Se Spin Enhancer è attivo, aumenta il tier
            if (activeItems.spinEnhancer) {
                const tierMap = { 'C': 'B', 'B': 'A', 'A': 'S', 'S': 'S', 'L': 'L' };
                tierToLoad = tierMap[selectedTier];
            }

            // Mappa tier al nome corretto del pool in Firebase
            const tierToPoolMap = {
                'C': 'c_tier',
                'B': 'b_tier',
                'A': 'a_tier',
                'S': 's_tier',
                'L': 'legendary'
            };

            const poolName = tierToPoolMap[tierToLoad];
            const poolRef = ref(database, `pools/${poolName}`);
            
            onValue(poolRef, (snapshot) => {
                const data = snapshot.val();
                let pool = data ? Object.entries(data).map(([key, value]) => ({
                    key: key,
                    ...value
                })) : [];

                // Filtra per tipo se Type Avoider è attivo
                if (activeItems.typeAvoider) {
                    pool = pool.filter(pokemon => {
                        return pokemon.primary_type !== activeItems.typeAvoider && 
                               pokemon.secondary_type !== activeItems.typeAvoider;
                    });
                }

                currentPool = pool;
                setupSlotMachine();
            }, { onlyOnce: true });
        }

        function setupSlotMachine() {
            const reel = document.getElementById('slotReel');
            
            if (currentPool.length === 0) {
                reel.innerHTML = '<div class="loading">Pool vuoto!</div>';
                return;
            }

            // Determina quanti Pokemon shiny ci saranno
            const shinyIndices = [];
            const poolSize = currentPool.length;
            
            for (let i = 0; i < Math.min(shinyPokemonCount, poolSize); i++) {
                let randomIndex;
                do {
                    randomIndex = Math.floor(Math.random() * poolSize);
                } while (shinyIndices.includes(randomIndex));
                shinyIndices.push(randomIndex);
            }

            // Crea abbastanza slot per coprire 3 schermate + extra per animazione smooth
            const totalSlots = Math.max(50, currentPool.length * 3);
            const slots = [];
            
            for (let i = 0; i < totalSlots; i++) {
                const poolIndex = i % currentPool.length;
                const pokemon = currentPool[poolIndex];
                const isShiny = shinyIndices.includes(poolIndex);
                slots.push({ pokemon, isShiny });
            }

            reel.innerHTML = slots.map(slot => `
                <div class="pokemon-slot">
                    ${slot.isShiny ? '<div class="shiny-badge">✨</div>' : ''}
                    <img src="${getPokemonImageUrl(slot.pokemon.national_number)}" 
                         alt="${slot.pokemon.english_name}">
                </div>
            `).join('');

            // Reset position
            reel.style.transition = 'none';
            reel.style.transform = 'translateX(100px)';
        }

        window.startSpin = async function() {
            if (isSpinning) return;

            if (currentPool.length === 0) {
                alert('Pool vuoto! Seleziona un tier diverso.');
                return;
            }

            isSpinning = true;
            document.getElementById('spinBtn').disabled = true;
            document.getElementById('resultPanel').classList.remove('show');

            // Seleziona Pokemon casuale
            const randomIndex = Math.floor(Math.random() * currentPool.length);
            wonPokemon = currentPool[randomIndex];
            wonPokemonKey = wonPokemon.key;

            // Determina se è shiny basandosi sul numero di shiny nel pool
            const shinyChance = shinyPokemonCount / currentPool.length;
            wonPokemon.isShiny = Math.random() < shinyChance;

            // Genera natura e abilità casuali
            const randomNature = natures[Math.floor(Math.random() * natures.length)];
            
            const abilities = [
                wonPokemon.abilities_0,
                wonPokemon.abilities_1,
                wonPokemon.abilities_2
            ].filter(a => a && a.trim() !== '');
            
            const randomAbility = abilities.length > 0 
                ? abilities[Math.floor(Math.random() * abilities.length)]
                : 'Unknown';

            wonPokemon.rolled_nature = randomNature;
            wonPokemon.rolled_ability = randomAbility;

            // Animazione slot machine
            const reel = document.getElementById('slotReel');
            const slotWidth = 170; // 150px + 20px gap
            
            const reelChildren = reel.children;
            const targetSlotIndex = Math.floor(reelChildren.length * 0.7);

            const machineWidth = document.querySelector('.slot-machine').offsetWidth;
            const machineCenter = machineWidth / 2;
            const slotCenter = slotWidth / 2;
            const targetPosition = (targetSlotIndex * slotWidth) + slotCenter;
            const finalTransform = machineCenter - targetPosition;

            reel.style.transition = 'transform 5s cubic-bezier(0.25, 0.1, 0.25, 1)';
            reel.style.transform = `translateX(${finalTransform}px)`;

            // Dopo l'animazione, mostra risultato
            setTimeout(async () => {
                showResult();
                
                // Consuma items se necessario
                if (activeItems.spinEnhancer) {
                    const currentCount = playerInventory.itemconsumabili['Spin Enhancer Cell'] || 0;
                    if (currentCount > 0) {
                        await update(ref(database), {
                            [`players/${playerName}/inventory/itemconsumabili/Spin Enhancer Cell`]: currentCount - 1
                        });
                    }
                    activeItems.spinEnhancer = false;
                }

                // Reset Type Avoider dopo lo spin
                if (activeItems.typeAvoider) {
                    activeItems.typeAvoider = null;
                }

                await loadPlayerInventory();
                renderItems();

                isSpinning = false;
                document.getElementById('spinBtn').disabled = false;
            }, 5000);
        };

        function showResult() {
            const resultPanel = document.getElementById('resultPanel');
            const resultPokemon = document.getElementById('resultPokemon');

            const types = [wonPokemon.primary_type];
            if (wonPokemon.secondary_type) types.push(wonPokemon.secondary_type);

            const shinyBadge = wonPokemon.isShiny ? '<div class="result-shiny-badge">✨</div>' : '';
            const shinyStatus = wonPokemon.isShiny ? '<div class="result-stat"><span class="shiny-text">⭐ SHINY! ⭐</span></div>' : '';

            resultPokemon.innerHTML = `
                <div class="result-pokemon-image">
                    ${shinyBadge}
                    <img src="${getPokemonImageUrl(wonPokemon.national_number)}" 
                         alt="${wonPokemon.english_name}">
                </div>
                <div class="result-info">
                    <h2>${wonPokemon.english_name}</h2>
                    <div class="result-stat"><strong>Numero:</strong> #${padNumber(wonPokemon.national_number)}</div>
                    <div class="result-stat"><strong>Tipo:</strong> ${types.join(' / ')}</div>
                    <div class="result-stat"><strong>BST:</strong> ${wonPokemon.bst}</div>
                    <div class="result-stat"><strong>Natura:</strong> ${wonPokemon.rolled_nature}</div>
                    <div class="result-stat"><strong>Abilità:</strong> ${wonPokemon.rolled_ability}</div>
                    ${shinyStatus}
                </div>
            `;

            resultPanel.classList.add('show');
        }

        window.addToTeam = async function() {
            let tierToSave = selectedTier;
            if (activeItems.spinEnhancer) {
                const tierMap = { 'C': 'B', 'B': 'A', 'A': 'S', 'S': 'S', 'L': 'L' };
                tierToSave = tierMap[selectedTier];
            }
            
            // Mappa tier al nome corretto del pool in Firebase
            const tierToPoolMap = {
                'C': 'c_tier',
                'B': 'b_tier',
                'A': 'a_tier',
                'S': 's_tier',
                'L': 'legendary'
            };
            
            const pool = tierToPoolMap[tierToSave];

            if (!wonPokemon) return;

            try {
                // 1. Aggiungi al rubyteam del giocatore
                const playerRef = ref(database, `players/${playerName}`);
                const playerSnapshot = await get(playerRef);
                
                let playerData = playerSnapshot.val() || { coins: 0, rubyteam: [] };
                if (!playerData.rubyteam) playerData.rubyteam = [];

                playerData.rubyteam.push({
                    ...wonPokemon,
                    nature: wonPokemon.rolled_nature,
                    ability: wonPokemon.rolled_ability,
                    shiny: wonPokemon.isShiny || false,
                    won_from: pool,
                    won_at: Date.now()
                });

                await set(playerRef, playerData);

                // 2. Rimuovi dal pool
                const pokemonRef = ref(database, `pools/${pool}/${wonPokemonKey}`);
                await remove(pokemonRef);

                const shinyMessage = wonPokemon.isShiny ? ' SHINY ✨' : '';
                alert(`${wonPokemon.english_name}${shinyMessage} aggiunto al Ruby Team!`);
                
                // Reset
                document.getElementById('resultPanel').classList.remove('show');
                loadPool();

            } catch (error) {
                console.error('Errore:', error);
                alert('Errore durante l\'aggiunta del Pokemon!');
            }
        };

        // Inizializzazione
        init();
    </script>
</body>
</html>
